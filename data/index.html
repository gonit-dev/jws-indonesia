<!doctype html>
<html class="no-js" lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Islamic Prayer Clock Settings</title>
    <link rel="stylesheet" href="assets/css/foundation.css">
    <style>
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: #1779ba;
            animation: spinner 1s ease-in-out infinite;
        }
        @keyframes spinner {
            to {transform: rotate(360deg);}
        }
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-online {
            background-color: #3adb76;
            color: white;
        }
        .status-offline {
            background-color: #cc4b37;
            color: white;
        }
        .status-loading {
            background-color: #ffae00;
            color: white;
        }
        .prayer-time-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .prayer-time-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .prayer-time-item:last-child {
            border-bottom: none;
        }
        .prayer-name {
            font-weight: bold;
            font-size: 16px;
        }
        .prayer-time {
            font-size: 18px;
            font-weight: bold;
        }
        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #1779ba;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .auto-badge {
            display: inline-block;
            background: #3adb76;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: #3adb76;
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 9999;
            font-size: 16px;
            font-weight: bold;
            transition: top 0.5s ease-in-out;
            min-width: 300px;
            text-align: center;
        }
        .toast.show {
            top: 30px;
        }
        .toast.error {
            background: #cc4b37;
        }
        .toast.warning {
            background: #ffae00;
        }
    </style>
</head>
<body>
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <div class="grid-container">
        <div class="grid-x grid-padding-x">
            <div class="large-12 text-center cell">
                
                <!-- Header -->
                <div class="grid-x grid-padding-y">
                    <div class="large-12 cell">
                        <h3>üïå Islamic Prayer Clock Settings</h3>
                        <p style="color: #666; font-size: 14px;">Semua pengaturan otomatis - tinggal sambungkan WiFi!</p>
                    </div>
                </div>

                <!-- WiFi & Device Status Section -->
                <div class="grid-x grid-padding-x">
                    <div class="large-10 center cell">
                        <div class="callout">
                            
                            <!-- WiFi Settings -->
                            <div class="grid-x grid-margin-x align-middle">
                                <div class="large-6 medium-6 cell">
                                    <div class="grid-x grid-padding-x">
                                        <div class="large-12 medium-12 small-12 cell">
                                            <h5>üì° WiFi Settings</h5>
                                            <div class="grid-x grid-margin-x">
                                                <div class="large-12 medium-12 small-12 cell">
                                                    <input type="text" id="wifiSSID" placeholder="WiFi SSID">
                                                </div>
                                                <div class="large-12 medium-12 small-12 cell">
                                                    <input type="password" id="wifiPassword" placeholder="WiFi Password">
                                                </div>
                                                <div class="large-12 medium-12 small-12 cell">
                                                    <button class="submit success button expanded" onclick="setWiFi()">
                                                        üíæ Set WiFi & Restart
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Access Point Settings -->
                                <div class="large-6 medium-6 cell">
                                    <h5>üì∂ Access Point Settings</h5>
                                    <div class="grid-x grid-margin-x">
                                        <div class="large-12 medium-12 small-12 cell">
                                            <input type="text" id="apSSID" placeholder="AP SSID">
                                        </div>
                                        <div class="large-12 medium-12 small-12 cell">
                                            <input type="password" id="apPassword" placeholder="AP Password">
                                        </div>
                                        <div class="large-12 medium-12 small-12 cell">
                                            <button class="submit success button expanded" onclick="setAP()">
                                                üíæ Set AP Config
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Device Status -->
                            <div class="grid-x grid-padding-y" style="margin-top: 20px;">
                                <div class="large-12 medium-12 small-12 cell">
                                    <div class="callout secondary">
                                        <h5>üìä Device Status</h5>
                                        <div class="grid-x grid-margin-x">
                                            <div class="large-6 medium-6 small-12 cell" style="text-align: left;">
                                                <p><strong>WiFi Network:</strong> <span id="wifiName">-</span></p>
                                                <p><strong>IP Address:</strong> <span id="ipAddress">-</span></p>
                                                <p><strong>Internet:</strong> <span id="internetStatus" class="status-badge status-loading">Checking...</span></p>
                                            </div>
                                            <div class="large-6 medium-6 small-12 cell" style="text-align: left;">
                                                <p><strong>NTP Status:</strong> <span id="ntpStatus">-</span></p>
                                                <p><strong>NTP Server:</strong> <span id="ntpServerUsed">-</span></p>
                                                <p><strong>Current Time:</strong> <span id="currentTime">-</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Time Sync Section -->
                <div class="grid-x grid-padding-x">
                    <div class="large-10 center cell">
                        <div class="callout">
                             <h5>‚è∞ Time Synchronization</h5>
                            <div class="grid-x grid-margin-x">
                                
                                <!-- Manual Sync -->
                                <div class="large-6 medium-6 cell">
                                    <div class="info-box">
                                         <h6>üì± Manual Sync from Browser</h6>
                                        <p style="font-size: 13px; margin: 10px 0; color: #666;">
                                            Sinkronkan waktu dari perangkat Anda
                                        </p>
                                        <button class="button expanded" style="color: #999;" onclick="syncTime()">
                                            üîÑ Sync Time Now
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Auto NTP Info -->
                                <div class="large-6 medium-6 cell">
                                    <div class="info-box" style="border-left-color: #3adb76;">
                                        <h6>üåê Auto NTP Sync <span class="auto-badge">AUTO</span></h6>
                                        <p style="font-size: 13px; margin: 10px 0; color: #666;">
                                            Waktu otomatis sync saat WiFi terhubung
                                        </p>
                                        <p style="font-size: 12px; margin: 0; color: #999;">
                                            ‚úì Auto-sync setiap 1 jam<br>
                                            ‚úì Multi-server fallback<br>
                                            ‚úì Timezone: WIB (UTC+7)
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- City Selection -->
                <div class="grid-x grid-padding-x">
                    <div class="large-10 center cell">
                        <div class="callout">
                            <h5>üìç Pilih Kota/Kabupaten</h5>
                            
                            <div class="info-box" style="text-align: center;">
                                <p style="margin: 0; font-size: 14px;">
                                    <strong>Kota/Kabupaten Terpilih:</strong><br>
                                    <span id="currentCity" style="font-size: 18px; font-weight: bold; color: #1779ba;">Belum dipilih</span>
                                </p>
                            </div>

                            <div class="grid-x grid-margin-x">
                                <div class="large-8 medium-8 small-12 cell">
                                    <select id="cityDropdown" style="width: 100%; padding: 10px; font-size: 14px; border-radius: 5px; border: 2px solid #e0e0e0;">
                                        <option value="">-- Pilih Kota/Kabupaten --</option>
                                    </select>
                                </div>
                                <div class="large-4 medium-4 small-12 cell">
                                    <button class="button success expanded" onclick="saveCity()">
                                        üíæ Simpan Kota/Kabupaten
                                    </button>
                                </div>
                            </div>

                            <div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                                <p style="margin: 0; font-size: 12px; color: #666;">
                                    ‚ÑπÔ∏è Pilih kota/Kabupaten untuk mendapatkan jadwal shalat yang akurat<br>
                                    üîÑ Jadwal akan otomatis update setelah kota/Kabupaten dipilih
                                </p>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Prayer Times Section -->
                <div class="grid-x grid-padding-x">
                    <div class="large-10 center cell">
                        <div class="callout">
                            <h5>üïå Jadwal Shalat</h5>

                            <!-- Prayer Times Display -->
                            <div class="prayer-time-box" id="prayerTimesBox">
                                <div class="prayer-time-item">
                                    <span class="prayer-name">üåÖ Subuh (Fajr)</span>
                                    <span class="prayer-time" id="subuhTime">--:--</span>
                                </div>
                                <div class="prayer-time-item">
                                    <span class="prayer-name">‚òÄÔ∏è Dzuhur (Dhuhr)</span>
                                    <span class="prayer-time" id="dzuhurTime">--:--</span>
                                </div>
                                <div class="prayer-time-item">
                                    <span class="prayer-name">üå§Ô∏è Ashar (Asr)</span>
                                    <span class="prayer-time" id="asharTime">--:--</span>
                                </div>
                                <div class="prayer-time-item">
                                    <span class="prayer-name">üåÜ Maghrib</span>
                                    <span class="prayer-time" id="maghribTime">--:--</span>
                                </div>
                                <div class="prayer-time-item">
                                    <span class="prayer-name">üåô Isya (Isha)</span>
                                    <span class="prayer-time" id="isyaTime">--:--</span>
                                </div>
                            </div>

                            <div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                                <p style="margin: 0; font-size: 12px; color: #666;">
                                    ‚ÑπÔ∏è Jadwal shalat berdasarkan kota/Kabupaten yang dipilih<br>
                                    üìÖ Auto-refresh setiap tengah malam (00:00 WIB)<br>
                                    üïã Metode kalkulasi: Kementerian Agama RI (Method 20)<br>
                                    üîÑ Update otomatis saat device online tanpa restart
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Factory Reset Section -->
                <div class="grid-x grid-padding-x">
                    <div class="large-10 center cell">
                        <div class="callout alert">
                            <h5>‚ö†Ô∏è Factory Reset</h5>
                            <p style="font-size: 14px; margin-bottom: 15px;">
                                Reset semua pengaturan (WiFi, waktu, jadwal shalat) ke default. Device akan restart.
                            </p>
                            <div style="background: #fff3cd; padding: 12px; border-radius: 5px; margin-bottom: 15px;">
                                <p style="margin: 0; font-size: 13px; color: #856404;">
                                    <strong>‚ö†Ô∏è Peringatan:</strong> Ini akan menghapus semua data tersimpan:
                                </p>
                                <p style="margin: 8px 0 0 20px; font-size: 12px; color: #856404;">
                                    üì° WiFi credentials<br>
                                    üïã Jadwal shalat tersimpan<br>
                                    üì∂ AP settings<br>
                                    üìç Pilihan kota/Kabupaten
                                </p>
                            </div>
                            <button class="alert button expanded" onclick="resetSettings()">
                                üîÑ Reset All Settings & Restart
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        async function secureFetch(url, options = {}) {
            if (url.includes('/api/data')) {
                return fetch(url, options);
            }
            
            if (!options.credentials) {
                options.credentials = 'same-origin';
            }
            
            try {
                const response = await fetch(url, options);
                
                if (response.status === 403) {
                    showToast('üîÑ Session expired - refreshing page...', 'warning');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                    throw new Error('Session expired');
                }
                
                return response;
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }

        let isOnline = false;
        let cityList = [];
        let loadAttempts = 0;
        const MAX_LOAD_ATTEMPTS = 3;

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            
            if (type === 'error') {
                toast.classList.add('error');
            } else if (type === 'warning') {
                toast.classList.add('warning');
            }
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        async function loadCities() {
            console.log(`üì• Loading cities (Attempt ${loadAttempts + 1}/${MAX_LOAD_ATTEMPTS})...`);
            
            const dropdown = document.getElementById('cityDropdown');
            dropdown.innerHTML = '<option value="">√¢¬è¬≥ Loading cities...</option>';
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                
                const response = await secureFetch('/getcities', {
                    method: 'GET',
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('Invalid or empty city list');
                }
                
                cityList = data;
                dropdown.innerHTML = '<option value="">-- Pilih Kota/Kabupaten --</option>';
                
                let currentProvince = '';
                data.forEach(city => {
                    if (city.province !== currentProvince) {
                        currentProvince = city.province;
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = '‚îÅ‚îÅ ' + currentProvince + ' ‚îÅ‚îÅ';
                        dropdown.appendChild(optgroup);
                    }
                    
                    const option = document.createElement('option');
                    option.value = city.api;
                    option.textContent = city.display;
                    
                    const lastOptgroup = dropdown.querySelector('optgroup:last-of-type');
                    if (lastOptgroup && lastOptgroup.label.includes(currentProvince)) {
                        lastOptgroup.appendChild(option);
                    } else {
                        dropdown.appendChild(option);
                    }
                });
                
                console.log(`‚úÖ Successfully loaded ${data.length} cities`);
                loadAttempts = 0;
                
                setTimeout(() => {
                    loadCurrentCity();
                }, 100);
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Error loading cities:', error.message);
                
                loadAttempts++;
                
                if (loadAttempts < MAX_LOAD_ATTEMPTS) {
                    const retryDelay = 2000 * loadAttempts;
                    console.log(`üîÑ Retrying in ${retryDelay/1000}s...`);
                    
                    dropdown.innerHTML = `<option value="">‚è≥ Retrying (${loadAttempts}/${MAX_LOAD_ATTEMPTS})...</option>`;
                    
                    setTimeout(() => {
                        loadCities();
                    }, retryDelay);
                } else {
                    console.error('‚ùå Failed to load cities after', MAX_LOAD_ATTEMPTS, 'attempts');
                    dropdown.innerHTML = '<option value="">‚ùå Gagal load kota/Kabupaten - Refresh halaman</option>';
                    showToast('‚ùå Gagal load daftar kota/Kabupaten. Refresh halaman untuk retry.', 'error');
                    loadAttempts = 0;
                }
                
                return false;
            }
        }

        async function loadCurrentCity() {
            console.log('üîÑ Loading current city selection...');
            
            try {
                const response = await secureFetch('/getcityinfo', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                
                const data = await response.json();
                
                const currentCitySpan = document.getElementById('currentCity');
                const dropdown = document.getElementById('cityDropdown');
                
                if (data.hasSelection && data.selectedCityApi) {
                    currentCitySpan.textContent = data.selectedCity || data.selectedCityApi;
                    currentCitySpan.style.color = '#1779ba';
                    dropdown.value = data.selectedCityApi;
                } else {
                    currentCitySpan.textContent = 'Belum dipilih';
                    currentCitySpan.style.color = '#999';
                    dropdown.selectedIndex = 0;
                }
                
            } catch (error) {
                console.error('‚ùå Error loading current city:', error);
                document.getElementById('currentCity').textContent = 'Error loading';
            }
        }

        async function saveCity() {
            const dropdown = document.getElementById('cityDropdown');
            const selectedCity = dropdown.value;
            
            if (!selectedCity) {
                showToast('‚ùå Pilih kota/Kabupaten terlebih dahulu', 'error');
                return;
            }
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ Menyimpan...';
            
            try {
                const response = await secureFetch('/setcity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `city=${encodeURIComponent(selectedCity)}`
                });
                
                if (response.ok) {
                    showToast('‚úÖ Kota/Kabupaten berhasil disimpan!', 'success');
                    loadCurrentCity();
                    
                    setTimeout(() => {
                        loadSavedPrayerTimes();
                    }, 2000);
                } else {
                    throw new Error('Save failed');
                }
            } catch (error) {
                console.error('Error:', error);
                 showToast('‚ùå Gagal menyimpan kota/Kabupaten', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function loadSavedPrayerTimes() {
            try {
                const response = await secureFetch('/getprayertimes');
                const data = await response.json();
                
                document.getElementById('subuhTime').textContent = data.subuh || '--:--';
                document.getElementById('dzuhurTime').textContent = data.dzuhur || '--:--';
                document.getElementById('asharTime').textContent = data.ashar || '--:--';
                document.getElementById('maghribTime').textContent = data.maghrib || '--:--';
                document.getElementById('isyaTime').textContent = data.isya || '--:--';
            } catch (error) {
                console.error('Error loading prayer times:', error);
            }
        }

        async function updateDeviceStatus() {
            try {
                const response = await secureFetch('/devicestatus');
                const data = await response.json();
                
                isOnline = data.connected === true;
                
                document.getElementById('wifiName').textContent = data.ssid || 'Tidak Terhubung';
                document.getElementById('ipAddress').textContent = data.ip || '-';
                 document.getElementById('ntpStatus').textContent = data.ntpSynced ? '‚úÖ Synced' : '‚ùå Not Synced';
                document.getElementById('currentTime').textContent = data.currentTime || '-';
                
                if (document.getElementById('ntpServerUsed')) {
                    document.getElementById('ntpServerUsed').textContent = data.ntpServer || '-';
                }
                
                const statusBadge = document.getElementById('internetStatus');
                
                if (isOnline) {
                    statusBadge.textContent = '‚úÖ Online';
                    statusBadge.className = 'status-badge status-online';
                } else {
                    statusBadge.textContent = '‚ùå Offline';
                    statusBadge.className = 'status-badge status-offline';
                }
            } catch (error) {
                console.error('Error fetching device status:', error);
                isOnline = false;
                document.getElementById('internetStatus').textContent = '‚ùå Error';
                document.getElementById('internetStatus').className = 'status-badge status-offline';
            }
        }
        
        function setWiFi() {
            const ssid = document.getElementById('wifiSSID').value.trim();
            const password = document.getElementById('wifiPassword').value;

            if (!ssid) {
                showToast('‚ùå SSID tidak boleh kosong', 'error');
                return;
            }

            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ Menyimpan...';

            secureFetch('/setwifi', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `ssid=${encodeURIComponent(ssid)}&password=${encodeURIComponent(password)}`
            })
            .then(response => {
                if (response.ok) {
                    showToast('‚úÖ WiFi berhasil disimpan!', 'success');
                    
                    setTimeout(() => {
                        showToast('üîÑ Device akan restart dalam 5 detik...', 'warning');
                    }, 1500);
                    
                    setTimeout(() => {
                        showToast('‚è≥ Tunggu 15-20 detik untuk koneksi ke: ' + ssid, 'warning');
                    }, 3500);
                    
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }, 6000);
                } else {
                    throw new Error('Save failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('‚ùå Gagal menyimpan WiFi', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            });
        }

        function setAP() {
            const ssid = document.getElementById('apSSID').value.trim();
            const password = document.getElementById('apPassword').value;

            if (!ssid) {
                showToast('‚ùå SSID AP tidak boleh kosong', 'error');
                return;
            }

            if (password.length > 0 && password.length < 8) {
                showToast('‚ùå Password minimal 8 karakter', 'error');
                return;
            }

            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ Menyimpan...';

            secureFetch('/setap', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `ssid=${encodeURIComponent(ssid)}&password=${encodeURIComponent(password)}`
            })
            .then(response => {
                if (response.ok) {
                    showToast('‚úÖ AP Settings berhasil disimpan!', 'success');
                    
                    setTimeout(() => {
                        showToast('üîÑ Device akan restart dalam 5 detik...', 'warning');
                    }, 1500);
                    
                    setTimeout(() => {
                        showToast('üì° Setelah restart, sambungkan ke AP: ' + ssid, 'warning');
                    }, 3500);
                    
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }, 6000);
                } else {
                    return response.text().then(text => {
                        throw new Error(text);
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('‚ùå ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            });
        }

        function syncTime() {
            const d = new Date();
            
            const year = d.getFullYear();
            const month = d.getMonth() + 1;
            const day = d.getDate();
            const hour = d.getHours();
            const minute = d.getMinutes();
            const second = d.getSeconds();

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Syncing...';

            secureFetch('/synctime', { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `y=${year}&m=${month}&d=${day}&h=${hour}&i=${minute}&s=${second}`
            })
            .then(response => response.text())
            .then(data => {
                showToast('‚úÖ Waktu berhasil di-sync!', 'success');
                updateDeviceStatus();
                btn.disabled = false;
                btn.textContent = 'üîÑ Sync Time Now';
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('‚ùå Gagal sync waktu', 'error');
                btn.disabled = false;
                btn.textContent = 'üîÑ Sync Time Now';
            });
        }

        function resetSettings() {
            if (!confirm('‚ö†Ô∏è Yakin ingin reset semua pengaturan? Device akan restart dan kembali ke default.')) {
                return;
            }

            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ Resetting...';

            fetch('/reset', { method: 'POST' })
            .then(response => {
                if (response.ok) {
                    showToast('‚úÖ Reset berhasil!', 'success');
                    
                    setTimeout(() => {
                        showToast('üîÑ Device akan restart dalam 5 detik...', 'warning');
                    }, 1500);
                    
                    setTimeout(() => {
                        showToast('üì° Sambungkan kembali ke AP: JWS ESP32', 'warning');
                    }, 3500);
                    
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }, 6000);
                } else {
                    throw new Error('Reset failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('‚ùå Gagal reset device', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Page loaded - Islamic Prayer Clock (City Selection Mode)');
            console.log('üìä Initialization sequence:');
            console.log('  1. Loading cities...');
            console.log('  2. Loading device status...');
            console.log('  3. Loading prayer times...');
            
            loadCities();
            updateDeviceStatus();
            loadSavedPrayerTimes();
            
            setInterval(updateDeviceStatus, 5000);
            setInterval(loadSavedPrayerTimes, 10000);
            
            console.log('‚úÖ Auto-refresh configured');
        });
        
        console.log('%cüïå Islamic Prayer Clock Web Interface', 'color: #667eea; font-size: 16px; font-weight: bold;');
        console.log('%c‚úì Optimized City Loading', 'color: #3adb76;');
        console.log('%c‚úì Retry Mechanism (3 attempts)', 'color: #3adb76;');
        console.log('%c‚úì 15s timeout per request', 'color: #3adb76;');
        console.log('%c‚úì Auto NTP Sync', 'color: #3adb76;');
        console.log('%c‚úì Auto Prayer Times Update (midnight)', 'color: #3adb76;');
        console.log('%c‚úì Security: Token-based authentication', 'color: #ffae00;');
    </script>
</body>
</html>