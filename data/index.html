<!doctype html>
<html class="no-js" lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Islamic Prayer Clock Settings</title>
    <link rel="stylesheet" href="assets/css/foundation.css">
    <style>
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: #1779ba;
            animation: spinner 1s ease-in-out infinite;
        }
        @keyframes spinner {
            to {transform: rotate(360deg);}
        }
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-online {
            background-color: #3adb76;
            color: white;
        }
        .status-offline {
            background-color: #cc4b37;
            color: white;
        }
        .status-loading {
            background-color: #ffae00;
            color: white;
        }
        .realtime-value {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #1779ba;
            font-size: 15px;
        }
        .prayer-time-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .prayer-time-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .prayer-time-item:last-child {
            border-bottom: none;
        }
        .prayer-name {
            font-weight: bold;
            font-size: 16px;
        }
        .prayer-time {
            font-size: 18px;
            font-weight: bold;
        }
        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #1779ba;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .auto-badge {
            display: inline-block;
            background: #3adb76;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: #3adb76;
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 9999;
            font-size: 16px;
            font-weight: bold;
            transition: top 0.5s ease-in-out;
            min-width: 300px;
            text-align: center;
        }
        .toast.show {
            top: 30px;
        }
        .toast.error {
            background: #cc4b37;
        }
        .toast.warning {
            background: #ffae00;
        }
    </style>
</head>
<body>
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <div class="grid-container">
        <div class="grid-x grid-padding-x">
            <div class="large-12 text-center cell">
                
                <!-- Header -->
                <div class="grid-x grid-padding-y">
                    <div class="large-12 cell">
                        <h3>üïå Islamic Prayer Clock Settings</h3>
                        <p style="color: #666; font-size: 14px;">Semua pengaturan otomatis - tinggal sambungkan WiFi!</p>
                    </div>
                </div>

                <!-- WiFi & Device Status Section -->
                <div class="grid-x grid-padding-x">
                    <div class="large-10 center cell">
                        <div class="callout">
                            
                            <!-- WiFi Settings -->
                            <div class="grid-x grid-margin-x align-middle">
                                <div class="large-6 medium-6 cell">
                                    <div class="grid-x grid-padding-x">
                                        <div class="large-12 medium-12 small-12 cell">
                                            <h5>üì° WiFi Settings</h5>
                                            <div class="grid-x grid-margin-x">
                                                <div class="large-12 medium-12 small-12 cell">
                                                    <input type="text" id="wifiSSID" placeholder="WiFi SSID">
                                                </div>
                                                <div class="large-12 medium-12 small-12 cell">
                                                    <input type="password" id="wifiPassword" placeholder="WiFi Password">
                                                </div>
                                                <div class="large-12 medium-12 small-12 cell">
                                                    <button class="submit success button expanded" onclick="setWiFi()">
                                                        üíæ Set WiFi & Restart
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Access Point Settings -->
                                <div class="large-6 medium-6 cell">
                                    <h5>üì∂ Access Point Settings</h5>
                                    <div class="grid-x grid-margin-x">
                                        <div class="large-12 medium-12 small-12 cell">
                                            <input type="text" id="apSSID" placeholder="AP SSID">
                                        </div>
                                        <div class="large-12 medium-12 small-12 cell">
                                            <input type="password" id="apPassword" placeholder="AP Password">
                                        </div>
                                        <div class="large-12 medium-12 small-12 cell">
                                            <button class="submit success button expanded" onclick="setAP()">
                                                üíæ Set AP Config
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Device Status -->
                            <div class="grid-x grid-padding-y" style="margin-top: 20px;">
                                <div class="large-12 medium-12 small-12 cell">
                                    <div class="callout secondary">
                                        <h5>üìä Device Status</h5>
                                        <div class="grid-x grid-margin-x">
                                            <div class="large-6 medium-6 small-12 cell" style="text-align: left;">
                                                <p><strong>WiFi Network:</strong> <span id="wifiName">-</span></p>
                                                <p><strong>IP Address:</strong> <span id="ipAddress">-</span></p>
                                                <p><strong>Internet:</strong> <span id="internetStatus" class="status-badge status-loading">Checking...</span></p>
                                            </div>
                                            <div class="large-6 medium-6 small-12 cell" style="text-align: left;">
                                                <p><strong>NTP Status:</strong> <span id="ntpStatus">-</span></p>
                                                <p><strong>NTP Server:</strong> <span id="ntpServerUsed">-</span></p>
                                                <p><strong>Current Time:</strong> <span id="currentTime" class="realtime-value">-</span></p>
                                                <p><strong>Current Date:</strong> <span id="currentDate" class="realtime-value">-</span></p>
                                                <p><strong>Uptime:</strong> <span id="uptime" class="realtime-value">--:--:--</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Time Sync Section -->
                <div class="grid-x grid-padding-x">
                    <div class="large-10 center cell">
                        <div class="callout">
                             <h5>‚è∞ Time Synchronization</h5>
                            <div class="grid-x grid-margin-x">
                                
                                <!-- Manual Sync -->
                                <div class="large-6 medium-6 cell">
                                    <div class="info-box">
                                         <h6>üì± Manual Sync from Browser</h6>
                                        <p style="font-size: 13px; margin: 10px 0; color: #666;">
                                            Sinkronkan waktu dari perangkat Anda
                                        </p>
                                        <button class="button expanded" style="color: #999;" onclick="syncTime()">
                                            üîÑ Sync Time Now
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Auto NTP Info -->
                                <div class="large-6 medium-6 cell">
                                    <div class="info-box" style="border-left-color: #3adb76;">
                                        <h6>üåê Auto NTP Sync <span class="auto-badge">AUTO</span></h6>
                                        <p style="font-size: 13px; margin: 10px 0; color: #666;">
                                            Waktu otomatis sync saat WiFi terhubung
                                        </p>
                                        <p style="font-size: 12px; margin: 0; color: #999;">
                                            ‚úì Auto-sync setiap 1 jam<br>
                                            ‚úì Multi-server fallback<br>
                                            ‚úì Timezone: WIB (UTC+7)
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- City Selection -->
                <div class="grid-x grid-padding-x">
                    <div class="large-10 center cell">
                        <div class="callout">
                            <h5>üìç Pilih Kota/Kabupaten</h5>
                            
                            <div class="info-box" style="text-align: center;">
                                <p style="margin: 0; font-size: 14px;">
                                    <strong>Kota/Kabupaten Terpilih:</strong><br>
                                    <span id="currentCity" style="font-size: 18px; font-weight: bold; color: #1779ba;">Belum dipilih</span>
                                </p>
                            </div>

                            <div class="grid-x grid-margin-x">
                                <div class="large-8 medium-8 small-12 cell">
                                    <select id="cityDropdown" style="width: 100%; padding: 10px; font-size: 14px; border-radius: 5px; border: 2px solid #e0e0e0;">
                                        <option value="">-- Pilih Kota/Kabupaten --</option>
                                    </select>
                                </div>
                                <div class="large-4 medium-4 small-12 cell">
                                    <button class="button success expanded" onclick="saveCity()">
                                        üíæ Simpan Kota/Kabupaten
                                    </button>
                                </div>
                            </div>

                            <div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                                <p style="margin: 0; font-size: 12px; color: #666;">
                                    ‚ÑπÔ∏è Pilih kota/Kabupaten untuk mendapatkan jadwal shalat yang akurat<br>
                                    üîÑ Jadwal akan otomatis update setelah kota/Kabupaten dipilih
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cities.json Upload Section -->
                <div class="grid-x grid-padding-x">
                    <div class="large-10 center cell">
                        <div class="callout warning">
                            <h5>üì§ Upload Cities.json</h5>
                            
                            <div class="info-box" style="border-left-color: #ffae00; background: #fff8e1;">
                                <p style="margin: 0; font-size: 13px; color: #856404;">
                                    <strong>‚ÑπÔ∏è Kapan perlu upload cities.json?</strong><br>
                                    üÜï Ada kota/kabupaten baru yang ditambahkan<br>
                                    üìç Data koordinat kota ada yang diperbarui<br>
                                    üîß File cities.json rusak atau terhapus
                                </p>
                            </div>

                            <div class="grid-x grid-margin-x">
                                <div class="large-8 medium-8 small-12 cell">
                                    <label for="citiesFileInput" class="button hollow expanded" style="margin: 0; cursor: pointer; text-align: center;">
                                        üìÅ Pilih File cities.json
                                        <input type="file" id="citiesFileInput" accept=".json" style="display: none;" onchange="handleCitiesFileSelect(event)">
                                    </label>
                                    <p id="selectedFileName" style="margin: 10px 0; font-size: 13px; color: #666; text-align: center;">
                                        Belum ada file dipilih
                                    </p>
                                </div>
                                <div class="large-4 medium-4 small-12 cell">
                                    <button id="uploadBtn" class="button warning expanded" onclick="uploadCitiesFile()" disabled>
                                        üì§ Upload File
                                    </button>
                                </div>
                            </div>

                            <div id="uploadProgress" style="display: none; margin-top: 15px;">
                                <div style="background: #e0e0e0; border-radius: 10px; overflow: hidden; height: 30px;">
                                    <div id="uploadProgressBar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 13px;">
                                        0%
                                    </div>
                                </div>
                                <p id="uploadStatus" style="margin: 10px 0; text-align: center; font-size: 13px; color: #666;">
                                    Memulai upload...
                                </p>
                            </div>

                            <div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                                <p style="margin: 0; font-size: 12px; color: #666;">
                                    ‚ö†Ô∏è <strong>Penting:</strong><br>
                                    üìù File harus bernama <code>cities.json</code><br>
                                    üîç Format harus valid JSON array<br>
                                    üíæ Ukuran maksimal: 1 MB<br>
                                    üîÑ Dropdown kota akan otomatis refresh setelah upload berhasil
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prayer Times Section -->
                <div class="grid-x grid-padding-x">
                    <div class="large-10 center cell">
                        <div class="callout">
                            <h5>üïå Jadwal Shalat</h5>

                            <!-- Prayer Times Display -->
                            <div class="prayer-time-box" id="prayerTimesBox">
                                <div class="prayer-time-item">
                                    <span class="prayer-name">üåÖ Subuh (Fajr)</span>
                                    <span class="prayer-time" id="subuhTime">--:--</span>
                                </div>
                                <div class="prayer-time-item">
                                    <span class="prayer-name">‚òÄÔ∏è Dzuhur (Dhuhr)</span>
                                    <span class="prayer-time" id="dzuhurTime">--:--</span>
                                </div>
                                <div class="prayer-time-item">
                                    <span class="prayer-name">üå§Ô∏è Ashar (Asr)</span>
                                    <span class="prayer-time" id="asharTime">--:--</span>
                                </div>
                                <div class="prayer-time-item">
                                    <span class="prayer-name">üåÜ Maghrib</span>
                                    <span class="prayer-time" id="maghribTime">--:--</span>
                                </div>
                                <div class="prayer-time-item">
                                    <span class="prayer-name">üåô Isya (Isha)</span>
                                    <span class="prayer-time" id="isyaTime">--:--</span>
                                </div>
                            </div>

                            <div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                                <p style="margin: 0; font-size: 12px; color: #666;">
                                    ‚ÑπÔ∏è Jadwal shalat berdasarkan kota/Kabupaten yang dipilih<br>
                                    üìÖ Auto-refresh setiap tengah malam (00:00 WIB)<br>
                                    üïã Metode kalkulasi: Egyptian General Authority of Survey<br>
                                    üîÑ Update otomatis saat device online tanpa restart
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Factory Reset Section -->
                <div class="grid-x grid-padding-x">
                    <div class="large-10 center cell">
                        <div class="callout alert">
                            <h5>‚ö†Ô∏è Factory Reset</h5>
                            <p style="font-size: 14px; margin-bottom: 15px;">
                                Reset semua pengaturan (WiFi, waktu, jadwal shalat) ke default. Device akan restart.
                            </p>
                            <div style="background: #fff3cd; padding: 12px; border-radius: 5px; margin-bottom: 15px;">
                                <p style="margin: 0; font-size: 13px; color: #856404;">
                                    <strong>‚ö†Ô∏è Peringatan:</strong> Ini akan menghapus semua data tersimpan:
                                </p>
                                <p style="margin: 8px 0 0 20px; font-size: 12px; color: #856404;">
                                    üì° WiFi credentials<br>
                                    üïã Jadwal shalat tersimpan<br>
                                    üì∂ AP settings<br>
                                    üìç Pilihan kota/Kabupaten<br>
                                    üìÖ Waktu dan tanggal
                                </p>
                            </div>
                            <button class="alert button expanded" onclick="resetSettings()">
                                üîÑ Reset All Settings & Restart
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // ================================
        // GLOBAL VARIABLES
        // ================================
        let isOnline = false;
        let cityList = [];
        let loadAttempts = 0;
        const MAX_LOAD_ATTEMPTS = 3;
        
        // Real-time clock sync
        let serverTimestamp = 0;
        let localStartTime = 0;
        let serverUptimeStart = 0;
        let lastSyncTime = 0;

        // ================================
        // REAL-TIME CLOCK FUNCTIONS
        // ================================
        function getCurrentTime() {
            if (serverTimestamp === 0 || localStartTime === 0) {
                return null;
            }
            
            const elapsedMs = Date.now() - localStartTime;
            const currentTimestamp = serverTimestamp + Math.floor(elapsedMs / 1000);
            
            return new Date(currentTimestamp * 1000);
        }

        function getCurrentUptime() {
            if (serverUptimeStart === 0 || localStartTime === 0) {
                return 0;
            }
            
            const elapsedMs = Date.now() - localStartTime;
            return serverUptimeStart + Math.floor(elapsedMs / 1000);
        }

        function formatTime(date) {
            if (!date) return '--:--:--';
            
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            
            return `${hours}:${minutes}:${seconds}`;
        }

        function formatUptime(seconds) {
            if (seconds === 0) return '--:--:--';
            
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (days > 0) {
                // Jika ada hari, tampilkan format: "Xd HH:MM:SS"
                return `${days}d ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            } else {
                // Jika belum 1 hari, format: "HH:MM:SS"
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }
        }

        function updateRealtimeDisplay() {
            const currentTime = getCurrentTime();
            const uptime = getCurrentUptime();
            
            const timeElement = document.getElementById('currentTime');
            const dateElement = document.getElementById('currentDate');
            const uptimeElement = document.getElementById('uptime');
            
            if (timeElement && currentTime) {
                const hours = String(currentTime.getHours()).padStart(2, '0');
                const minutes = String(currentTime.getMinutes()).padStart(2, '0');
                const seconds = String(currentTime.getSeconds()).padStart(2, '0');
                timeElement.textContent = `${hours}:${minutes}:${seconds}`;
            }
            
            if (dateElement && currentTime) {
                const day = String(currentTime.getDate()).padStart(2, '0');
                const month = String(currentTime.getMonth() + 1).padStart(2, '0');
                const year = currentTime.getFullYear();
                dateElement.textContent = `${day}/${month}/${year}`;
            }
            
            if (uptimeElement) {
                uptimeElement.textContent = formatUptime(uptime);
            }
        }

        // ================================
        // SECURE FETCH WRAPPER
        // ================================
        async function secureFetch(url, options = {}) {
            if (!options.credentials) {
                options.credentials = 'same-origin';
            }
            
            try {
                const response = await fetch(url, options);
                
                if (response.status === 403) {
                    showToast('üîÑ Session expired - refreshing page...', 'warning');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                    throw new Error('Session expired');
                }
                
                return response;
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }

        // ================================
        // TOAST NOTIFICATION
        // ================================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            
            if (type === 'error') {
                toast.classList.add('error');
            } else if (type === 'warning') {
                toast.classList.add('warning');
            }
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        // ================================
        // DEVICE STATUS UPDATE
        // ================================
        async function updateDeviceStatus() {
            try {
                const response = await secureFetch('/devicestatus');
                const data = await response.json();
                
                isOnline = data.connected === true;
                
                // Update WiFi info
                document.getElementById('wifiName').textContent = data.ssid || 'Tidak Terhubung';
                document.getElementById('ipAddress').textContent = data.ip || '-';
                document.getElementById('ntpStatus').textContent = data.ntpSynced ? '‚úÖ Synced' : '‚ùå Not Synced';
                
                if (document.getElementById('ntpServerUsed')) {
                    document.getElementById('ntpServerUsed').textContent = data.ntpServer || '-';
                }
                
                // Update internet status badge
                const statusBadge = document.getElementById('internetStatus');
                if (isOnline) {
                    statusBadge.textContent = '‚úÖ Online';
                    statusBadge.className = 'status-badge status-online';
                } else {
                    statusBadge.textContent = '‚ùå Offline';
                    statusBadge.className = 'status-badge status-offline';
                }
                
                // ================================
                // SYNC TIME & DATE FROM SERVER
                // ================================
                if (data.currentTime && data.currentDate) {
                    const timeParts = data.currentTime.split(':');
                    const dateParts = data.currentDate.split('/');
                    
                    if (timeParts.length === 3 && dateParts.length === 3) {
                        const now = new Date(
                            parseInt(dateParts[2]), // year
                            parseInt(dateParts[1]) - 1, // month (0-indexed)
                            parseInt(dateParts[0]), // day
                            parseInt(timeParts[0]), // hour
                            parseInt(timeParts[1]), // minute
                            parseInt(timeParts[2])  // second
                        );
                        
                        serverTimestamp = Math.floor(now.getTime() / 1000);
                        localStartTime = Date.now();
                        lastSyncTime = Date.now();
                        
                        console.log('‚è∞ Time synced:', data.currentTime, data.currentDate);
                    }
                }
                
                // Sync uptime
                if (data.uptime !== undefined) {
                    serverUptimeStart = data.uptime;
                    console.log('‚è±Ô∏è Uptime synced:', serverUptimeStart, 'seconds');
                }
                
                // Free heap display
                if (document.getElementById('freeHeap')) {
                    const heapKB = Math.floor(parseInt(data.freeHeap) / 1024);
                    document.getElementById('freeHeap').textContent = heapKB + ' KB';
                }
                
            } catch (error) {
                console.error('Error fetching device status:', error);
                isOnline = false;
                document.getElementById('internetStatus').textContent = '‚ùå Error';
                document.getElementById('internetStatus').className = 'status-badge status-offline';
            }
        }
        
        // ================================
        // CITY LOADING FUNCTIONS
        // ================================
        async function loadCities() {
            console.log(`üì• Loading cities (Attempt ${loadAttempts + 1}/${MAX_LOAD_ATTEMPTS})...`);
            
            const dropdown = document.getElementById('cityDropdown');
            dropdown.innerHTML = '<option value="">‚è≥ Loading cities...</option>';
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                
                const response = await secureFetch('/getcities', {
                    method: 'GET',
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('Invalid or empty city list');
                }
                
                cityList = data;
                dropdown.innerHTML = '<option value="">-- Pilih Kota/Kabupaten --</option>';
                
                let currentProvince = '';
                data.forEach(city => {
                    if (city.province !== currentProvince) {
                        currentProvince = city.province;
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = '‚îå‚îÄ ' + currentProvince + ' ‚îÄ‚îê';
                        dropdown.appendChild(optgroup);
                    }
                    
                    const option = document.createElement('option');
                    option.value = city.api;
                    
                    let displayText = city.display;
                    if (city.lat && city.lon) {
                        displayText += ` (${parseFloat(city.lat).toFixed(2)}¬∞, ${parseFloat(city.lon).toFixed(2)}¬∞)`;
                    }
                    option.textContent = displayText;
                    
                    option.setAttribute('data-lat', city.lat);
                    option.setAttribute('data-lon', city.lon);
                    
                    const lastOptgroup = dropdown.querySelector('optgroup:last-of-type');
                    if (lastOptgroup && lastOptgroup.label.includes(currentProvince)) {
                        lastOptgroup.appendChild(option);
                    } else {
                        dropdown.appendChild(option);
                    }
                });
                
                console.log(`‚úÖ Successfully loaded ${data.length} cities with coordinates`);
                loadAttempts = 0;
                
                setTimeout(() => {
                    loadCurrentCity();
                }, 100);
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Error loading cities:', error.message);
                
                loadAttempts++;
                
                if (loadAttempts < MAX_LOAD_ATTEMPTS) {
                    const retryDelay = 2000 * loadAttempts;
                    console.log(`üîÑ Retrying in ${retryDelay/1000}s...`);
                    
                    dropdown.innerHTML = `<option value="">‚è≥ Retrying (${loadAttempts}/${MAX_LOAD_ATTEMPTS})...</option>`;
                    
                    setTimeout(() => {
                        loadCities();
                    }, retryDelay);
                } else {
                    console.error('‚ùå Failed to load cities after', MAX_LOAD_ATTEMPTS, 'attempts');
                    dropdown.innerHTML = '<option value="">‚ùå Gagal load kota/kabupaten - Refresh halaman</option>';
                    showToast('‚ùå Gagal load daftar kota/kabupaten. Refresh halaman untuk retry.', 'error');
                    loadAttempts = 0;
                }
                
                return false;
            }
        }

        async function loadCurrentCity() {
            console.log('üîÑ Loading current city selection...');
            
            try {
                const response = await secureFetch('/getcityinfo', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                
                const data = await response.json();
                
                const currentCitySpan = document.getElementById('currentCity');
                const dropdown = document.getElementById('cityDropdown');
                
                if (data.hasSelection && data.selectedCityApi) {
                    let displayText = data.selectedCity;
                    
                    if (data.latitude && data.longitude) {
                        displayText += ` (${parseFloat(data.latitude).toFixed(4)}¬∞, ${parseFloat(data.longitude).toFixed(4)}¬∞)`;
                    }
                    
                    currentCitySpan.textContent = displayText;
                    currentCitySpan.style.color = '#1779ba';
                    
                    dropdown.value = data.selectedCityApi;
                    
                    console.log('‚úÖ City loaded:', displayText);
                    console.log('   Dropdown value:', data.selectedCityApi);
                } else {
                    currentCitySpan.textContent = 'Belum dipilih';
                    currentCitySpan.style.color = '#999';
                    dropdown.selectedIndex = 0;
                }
                
            } catch (error) {
                console.error('‚ùå Error loading current city:', error);
                document.getElementById('currentCity').textContent = 'Error loading';
            }
        }

        async function saveCity() {
            console.log('========================================');
            console.log('saveCity() called');
            console.log('========================================');
            
            const dropdown = document.getElementById('cityDropdown');
            const selectedCity = dropdown.value;
            
            console.log('Selected value:', selectedCity);
            
            if (!selectedCity) {
                console.error('‚ùå No city selected');
                showToast('‚ùå Pilih kota/kabupaten terlebih dahulu', 'error');
                return;
            }
            
            const selectedOption = dropdown.options[dropdown.selectedIndex];
            const lat = selectedOption.getAttribute('data-lat');
            const lon = selectedOption.getAttribute('data-lon');
            const displayName = selectedOption.textContent.split('(')[0].trim();
            
            console.log('City data:');
            console.log('  API:', selectedCity);
            console.log('  Display:', displayName);
            console.log('  Lat:', lat);
            console.log('  Lon:', lon);
            
            if (!lat || !lon) {
                console.error('‚ùå Missing coordinates');
                showToast('‚ùå Data koordinat tidak lengkap', 'error');
                return;
            }
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ Menyimpan...';
            
            try {
                console.log('Sending POST request to /setcity...');
                
                const formData = new URLSearchParams();
                formData.append('city', selectedCity);
                formData.append('cityName', displayName);
                formData.append('lat', lat);
                formData.append('lon', lon);
                
                console.log('POST data:', formData.toString());
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); 
                
                const response = await secureFetch('/setcity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Accept': 'application/json'
                    },
                    body: formData.toString(),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                console.log('Response status:', response.status);
                
                const contentType = response.headers.get('content-type');
                let responseData;
                
                if (contentType && contentType.includes('application/json')) {
                    responseData = await response.json();
                    console.log('Response JSON:', responseData);
                } else {
                    responseData = await response.text();
                    console.log('Response text:', responseData);
                }
                
                if (response.ok) {
                    console.log('‚úÖ City saved successfully');
                    showToast('‚úÖ Kota/Kabupaten berhasil disimpan!', 'success');
                    
                    setTimeout(() => {
                        showToast(`üìç ${selectedCity} - Koordinat: ${parseFloat(lat).toFixed(4)}¬∞, ${parseFloat(lon).toFixed(4)}¬∞`, 'success');
                    }, 2000);
                    
                    setTimeout(() => {
                        console.log('Reloading city info...');
                        loadCurrentCity();
                    }, 1000);
                    
                    setTimeout(() => {
                        console.log('Reloading prayer times...');
                        loadSavedPrayerTimes();
                    }, 3000);
                    
                } else {
                    let errorMsg = 'Unknown error';
                    
                    if (typeof responseData === 'object' && responseData.error) {
                        errorMsg = responseData.error;
                    } else if (typeof responseData === 'string') {
                        errorMsg = responseData;
                    }
                    
                    throw new Error(errorMsg);
                }
                
            } catch (error) {
                console.error('‚ùå Error saving city:', error);
                
                let errorMessage = 'Gagal menyimpan kota/kabupaten';
                
                if (error.name === 'AbortError') {
                    errorMessage = 'Request timeout - coba lagi';
                } else if (error.message.includes('Session expired')) {
                    errorMessage = 'Session habis - refresh halaman';
                    setTimeout(() => window.location.reload(), 2000);
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showToast('‚ùå ' + errorMessage, 'error');
                
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
                console.log('========================================\n');
            }
        }

        // ================================
        // PRAYER TIMES
        // ================================
        async function loadSavedPrayerTimes() {
            try {
                const response = await secureFetch('/getprayertimes');
                const data = await response.json();
                
                document.getElementById('subuhTime').textContent = data.subuh || '--:--';
                document.getElementById('dzuhurTime').textContent = data.dzuhur || '--:--';
                document.getElementById('asharTime').textContent = data.ashar || '--:--';
                document.getElementById('maghribTime').textContent = data.maghrib || '--:--';
                document.getElementById('isyaTime').textContent = data.isya || '--:--';
            } catch (error) {
                console.error('Error loading prayer times:', error);
            }
        }

        // ================================
        // WIFI & AP SETTINGS
        // ================================
        function setWiFi() {
            const ssid = document.getElementById('wifiSSID').value.trim();
            const password = document.getElementById('wifiPassword').value;

            if (!ssid) {
                showToast('‚ùå SSID tidak boleh kosong', 'error');
                return;
            }

            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ Menyimpan...';

            secureFetch('/setwifi', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `ssid=${encodeURIComponent(ssid)}&password=${encodeURIComponent(password)}`
            })
            .then(response => {
                if (response.ok) {
                    showToast('‚úÖ WiFi berhasil disimpan!', 'success');
                    
                    setTimeout(() => {
                        showToast('üîÑ Device akan restart dalam 5 detik...', 'warning');
                    }, 1500);
                    
                    setTimeout(() => {
                        showToast('‚è≥ Tunggu 15-20 detik untuk koneksi ke: ' + ssid, 'warning');
                    }, 3500);
                    
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }, 6000);
                } else {
                    throw new Error('Save failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('‚ùå Gagal menyimpan WiFi', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            });
        }

        function setAP() {
            const ssid = document.getElementById('apSSID').value.trim();
            const password = document.getElementById('apPassword').value;

            if (!ssid) {
                showToast('‚ùå SSID AP tidak boleh kosong', 'error');
                return;
            }

            if (password.length > 0 && password.length < 8) {
                showToast('‚ùå Password minimal 8 karakter', 'error');
                return;
            }

            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ Menyimpan...';

            secureFetch('/setap', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `ssid=${encodeURIComponent(ssid)}&password=${encodeURIComponent(password)}`
            })
            .then(response => {
                if (response.ok) {
                    showToast('‚úÖ AP Settings berhasil disimpan!', 'success');
                    
                    setTimeout(() => {
                        showToast('üîÑ Device akan restart dalam 5 detik...', 'warning');
                    }, 1500);
                    
                    setTimeout(() => {
                        showToast('üì° Setelah restart, sambungkan ke AP: ' + ssid, 'warning');
                    }, 3500);
                    
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }, 6000);
                } else {
                    return response.text().then(text => {
                        throw new Error(text);
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('‚ùå ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            });
        }

        // ================================
        // TIME SYNC
        // ================================
        function syncTime() {
            const d = new Date();
            
            const year = d.getFullYear();
            const month = d.getMonth() + 1;
            const day = d.getDate();
            const hour = d.getHours();
            const minute = d.getMinutes();
            const second = d.getSeconds();

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Syncing...';

            secureFetch('/synctime', { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `y=${year}&m=${month}&d=${day}&h=${hour}&i=${minute}&s=${second}`
            })
            .then(response => response.text())
            .then(data => {
                showToast('‚úÖ Waktu berhasil di-sync!', 'success');
                updateDeviceStatus();
                btn.disabled = false;
                btn.textContent = 'üîÑ Sync Time Now';
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('‚ùå Gagal sync waktu', 'error');
                btn.disabled = false;
                btn.textContent = 'üîÑ Sync Time Now';
            });
        }

        // ================================
        // FACTORY RESET
        // ================================
        function resetSettings() {
            if (!confirm('‚ö†Ô∏è Yakin ingin reset semua pengaturan? Device akan restart dan kembali ke default.')) {
                return;
            }

            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ Resetting...';

            fetch('/reset', { method: 'POST' })
            .then(response => {
                if (response.ok) {
                    showToast('‚úÖ Reset berhasil!', 'success');
                    
                    setTimeout(() => {
                        showToast('üîÑ Device akan restart dalam 5 detik...', 'warning');
                    }, 1500);
                    
                    setTimeout(() => {
                        showToast('üì° Sambungkan kembali ke AP: JWS ESP32', 'warning');
                    }, 3500);
                    
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }, 6000);
                } else {
                    throw new Error('Reset failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('‚ùå Gagal reset device', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            });
        }

        // ================================
        // CITIES.JSON UPLOAD FUNCTIONS
        // ================================
        let selectedCitiesFile = null;

        function calculateArduinoJsonSize(json) {
            
            let totalSize = 0;
            
            totalSize += 24; 
            
            if (Array.isArray(json)) {
                totalSize += 16;
                totalSize += json.length * 8;
                
                json.forEach(item => {
                    if (typeof item === 'object' && item !== null) {
                        totalSize += 16;
                        
                        const keys = Object.keys(item);
                        totalSize += keys.length * 24;
                        
                        keys.forEach(key => {
                            totalSize += key.length + 1;
                            totalSize += Math.ceil((key.length + 1) / 4) * 4;
                            
                            // Value
                            const value = item[key];
                            if (typeof value === 'string') {
                                totalSize += value.length + 1;
                                totalSize += Math.ceil((value.length + 1) / 4) * 4;
                            } else if (typeof value === 'number') {
                                totalSize += 8; // double
                            } else if (typeof value === 'boolean') {
                                totalSize += 1;
                            }
                        });
                    }
                });
            }
            
            totalSize = Math.ceil(totalSize * 1.2);
            
            return totalSize;
        }

        function handleCitiesFileSelect(event) {
            const file = event.target.files[0];
            const fileNameDisplay = document.getElementById('selectedFileName');
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (!file) {
                selectedCitiesFile = null;
                fileNameDisplay.textContent = 'Belum ada file dipilih';
                fileNameDisplay.style.color = '#666';
                uploadBtn.disabled = true;
                return;
            }
            
            if (file.name !== 'cities.json') {
                showToast('‚ùå Nama file harus cities.json', 'error');
                selectedCitiesFile = null;
                fileNameDisplay.textContent = '‚ùå Nama file tidak valid';
                fileNameDisplay.style.color = '#cc4b37';
                uploadBtn.disabled = true;
                event.target.value = '';
                return;
            }
            
            const maxSize = 1 * 1024 * 1024;
            if (file.size > maxSize) {
                showToast('‚ùå File terlalu besar (max 1MB)', 'error');
                selectedCitiesFile = null;
                fileNameDisplay.textContent = '‚ùå File terlalu besar';
                fileNameDisplay.style.color = '#cc4b37';
                uploadBtn.disabled = true;
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // Validasi 3: Parse JSON
                    const json = JSON.parse(e.target.result);
                    
                    // Validasi 4: Harus array
                    if (!Array.isArray(json)) {
                        throw new Error('JSON harus berupa array');
                    }
                    
                    // Validasi 5: Tidak boleh kosong
                    if (json.length === 0) {
                        throw new Error('JSON array tidak boleh kosong');
                    }
                    
                    // Validasi 6: Struktur field wajib
                    const requiredFields = ['api', 'display', 'province'];
                    const optionalFields = ['lat', 'lon'];
                    
                    for (let i = 0; i < json.length; i++) {
                        const item = json[i];
                        
                        // Cek field wajib
                        for (const field of requiredFields) {
                            if (!item.hasOwnProperty(field) || !item[field]) {
                                throw new Error(`Item ${i}: field '${field}' tidak ada atau kosong`);
                            }
                            
                            if (typeof item[field] !== 'string') {
                                throw new Error(`Item ${i}: field '${field}' harus string`);
                            }
                        }
                        
                        if (item.lat) {
                            const lat = parseFloat(item.lat);
                            if (isNaN(lat) || lat < -90 || lat > 90) {
                                throw new Error(`Item ${i}: latitude tidak valid (${item.lat})`);
                            }
                        }
                        
                        if (item.lon) {
                            const lon = parseFloat(item.lon);
                            if (isNaN(lon) || lon < -180 || lon > 180) {
                                throw new Error(`Item ${i}: longitude tidak valid (${item.lon})`);
                            }
                        }
                    }
                    
                    const jsonSize = calculateArduinoJsonSize(json);
                    
                    console.log('JSON Validation Results:');
                    console.log('  ‚úÖ File name:', file.name);
                    console.log('  ‚úÖ File size:', (file.size / 1024).toFixed(2), 'KB');
                    console.log('  ‚úÖ Cities count:', json.length);
                    console.log('  ‚úÖ JSON structure: Valid');
                    console.log('  üìä DynamicJsonDocument size needed:', jsonSize, 'bytes');
                    
                    const ESP32_MAX_HEAP = 320000;
                    
                    if (jsonSize > ESP32_MAX_HEAP) {
                        const sizeKB = (jsonSize / 1024).toFixed(2);
                        const maxKB = (ESP32_MAX_HEAP / 1024).toFixed(2);
                        
                        showToast(
                            `‚ùå File terlalu berat untuk ESP32!\n` +
                            `Ukuran JSON: ${sizeKB} KB\n` +
                            `Max safe: ${maxKB} KB\n` +
                            `Kurangi jumlah kota atau persingkat field`,
                            'error'
                        );
                        
                        selectedCitiesFile = null;
                        fileNameDisplay.textContent = `‚ùå Terlalu berat (${sizeKB} KB > ${maxKB} KB)`;
                        fileNameDisplay.style.color = '#cc4b37';
                        uploadBtn.disabled = true;
                        event.target.value = '';
                        return;
                    }
                    
                    // File valid - simpan metadata
                    selectedCitiesFile = file;
                    selectedCitiesFile.jsonMetadata = {
                        citiesCount: json.length,
                        jsonSize: jsonSize,
                        fileSize: file.size
                    };
                    
                    const sizeKB = (file.size / 1024).toFixed(2);
                    const jsonSizeKB = (jsonSize / 1024).toFixed(2);
                    
                    fileNameDisplay.innerHTML = 
                        `‚úÖ ${file.name} (${sizeKB} KB)<br>` +
                        `üìä ${json.length} kota | DynamicJsonDocument: ${jsonSizeKB} KB`;
                    fileNameDisplay.style.color = '#3adb76';
                    uploadBtn.disabled = false;
                    
                } catch (error) {
                    showToast('‚ùå Validasi gagal: ' + error.message, 'error');
                    selectedCitiesFile = null;
                    fileNameDisplay.textContent = '‚ùå ' + error.message;
                    fileNameDisplay.style.color = '#cc4b37';
                    uploadBtn.disabled = true;
                    event.target.value = '';
                    console.error('JSON validation error:', error);
                }
            };
            
            reader.onerror = function() {
                showToast('‚ùå Gagal membaca file', 'error');
                selectedCitiesFile = null;
                fileNameDisplay.textContent = '‚ùå Gagal membaca file';
                fileNameDisplay.style.color = '#cc4b37';
                uploadBtn.disabled = true;
            };
            
            reader.readAsText(file);
        }

        async function uploadCitiesFile() {
            if (!selectedCitiesFile) {
                showToast('‚ùå Pilih file terlebih dahulu', 'error');
                return;
            }
            
            console.log('========================================');
            console.log('Starting cities.json upload...');
            console.log('File:', selectedCitiesFile.name);
            console.log('Size:', selectedCitiesFile.size, 'bytes');
            
            if (selectedCitiesFile.jsonMetadata) {
                console.log('Cities:', selectedCitiesFile.jsonMetadata.citiesCount);
                console.log('JSON Size:', selectedCitiesFile.jsonMetadata.jsonSize, 'bytes');
            }
            
            console.log('========================================');
            
            const uploadBtn = document.getElementById('uploadBtn');
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('uploadProgressBar');
            const statusText = document.getElementById('uploadStatus');
            
            uploadBtn.disabled = true;
            uploadBtn.textContent = '‚è≥ Uploading...';
            progressDiv.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            statusText.textContent = 'Memulai upload...';
            
            try {
                const formData = new FormData();
                formData.append('file', selectedCitiesFile);
                
                // Tambahkan metadata
                if (selectedCitiesFile.jsonMetadata) {
                    formData.append('jsonSize', selectedCitiesFile.jsonMetadata.jsonSize);
                    formData.append('citiesCount', selectedCitiesFile.jsonMetadata.citiesCount);
                }
                
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = percentComplete + '%';
                        progressBar.textContent = percentComplete + '%';
                        statusText.textContent = `Uploading: ${(e.loaded / 1024).toFixed(1)} KB / ${(e.total / 1024).toFixed(1)} KB`;
                        console.log(`Upload progress: ${percentComplete}%`);
                    }
                });
                
                xhr.addEventListener('load', async () => {
                    console.log('Upload response status:', xhr.status);
                    console.log('Response:', xhr.responseText);
                    
                    if (xhr.status === 200) {
                        let response;
                        try {
                            response = JSON.parse(xhr.responseText);
                        } catch (e) {
                            response = { success: true };
                        }
                        
                        progressBar.style.width = '100%';
                        progressBar.textContent = '100%';
                        statusText.textContent = '‚úÖ Upload berhasil!';
                        statusText.style.color = '#3adb76';
                        
                        console.log('‚úÖ Upload successful');
                        
                        if (selectedCitiesFile.jsonMetadata) {
                            const jsonSizeKB = (selectedCitiesFile.jsonMetadata.jsonSize / 1024).toFixed(2);
                            showToast(
                                `‚úÖ cities.json berhasil diupload!\n` +
                                `üìä ${selectedCitiesFile.jsonMetadata.citiesCount} kota\n` +
                                `üíæ DynamicJsonDocument: ${jsonSizeKB} KB`,
                                'success'
                            );
                        } else {
                            showToast('‚úÖ cities.json berhasil diupload!', 'success');
                        }
                        
                        // Reset form
                        document.getElementById('citiesFileInput').value = '';
                        document.getElementById('selectedFileName').textContent = 'Belum ada file dipilih';
                        document.getElementById('selectedFileName').style.color = '#666';
                        selectedCitiesFile = null;
                        
                        // Reload cities list
                        setTimeout(() => {
                            showToast('üîÑ Memuat ulang daftar kota...', 'warning');
                            loadAttempts = 0;
                            loadCities();
                        }, 2000);
                        
                        setTimeout(() => {
                            progressDiv.style.display = 'none';
                            uploadBtn.disabled = false;
                            uploadBtn.textContent = 'üì§ Upload File';
                        }, 5000);
                        
                    } else {
                        let errorMsg = 'Upload failed';
                        try {
                            const response = JSON.parse(xhr.responseText);
                            errorMsg = response.error || errorMsg;
                        } catch (e) {
                            errorMsg = xhr.responseText || errorMsg;
                        }
                        throw new Error(errorMsg);
                    }
                });
                
                xhr.addEventListener('error', () => {
                    throw new Error('Network error - koneksi terputus');
                });
                
                xhr.addEventListener('timeout', () => {
                    throw new Error('Upload timeout - file terlalu lama');
                });
                
                xhr.open('POST', '/uploadcities', true);
                xhr.timeout = 30000;
                xhr.send(formData);
                
            } catch (error) {
                console.error('‚ùå Upload error:', error);
                
                progressBar.style.background = '#cc4b37';
                progressBar.style.width = '100%';
                statusText.textContent = '‚ùå ' + error.message;
                statusText.style.color = '#cc4b37';
                
                showToast('‚ùå Upload gagal: ' + error.message, 'error');
                
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'üì§ Upload File';
                }, 3000);
            }
        }

        // ================================
        // INITIALIZATION
        // ================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Page loaded - Islamic Prayer Clock (Real-time Mode)');
            console.log('üìä Initialization sequence:');
            console.log('  1. Loading cities...');
            console.log('  2. Loading device status...');
            console.log('  3. Loading prayer times...');
            console.log('  4. Starting real-time clock...');
            
            // Load initial data
            loadCities();
            updateDeviceStatus();
            loadSavedPrayerTimes();
            
            // ================================
            // REAL-TIME CLOCK - UPDATE EVERY 1 SECOND
            // ================================
            setInterval(updateRealtimeDisplay, 1000);
            console.log('‚úÖ Real-time clock started (1s interval)');
            
            // ================================
            // SERVER SYNC - EVERY 5 SECONDS
            // ================================
            setInterval(updateDeviceStatus, 5000);
            console.log('‚úÖ Device status sync (5s interval)');
            
            // ================================
            // PRAYER TIMES REFRESH - EVERY 30 SECONDS
            // ================================
            setInterval(loadSavedPrayerTimes, 30000);
            console.log('‚úÖ Prayer times refresh (30s interval)');
            
            console.log('‚úÖ All timers configured');
        });
        
        console.log('%cüïå Islamic Prayer Clock Web Interface', 'color: #667eea; font-size: 16px; font-weight: bold;');
        console.log('%c‚úì Real-time Clock (1s update)', 'color: #3adb76;');
        console.log('%c‚úì Auto Server Sync (5s)', 'color: #3adb76;');
        console.log('%c‚úì Optimized City Loading', 'color: #3adb76;');
        console.log('%c‚úì Auto NTP Sync', 'color: #3adb76;');
        console.log('%c‚úì Security: Token-based auth', 'color: #ffae00;');
    </script>
</body>
</html>