<!doctype html>
<html class="no-js" lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Jadwal Shalat</title>
	<link rel="stylesheet" href="assets/css/foundation.min.css">
	<style>
	html,
	body {
		height: 100%;
		margin: 0;
		padding: 0;
		overflow-x: hidden;
	}

	body {
		min-height: 100vh;
		position: relative;
	}

	/* ================================
	PAGE LOADER
	================================ */
	#pageLoader {
		position: fixed;
		inset: 0;
		background: #ffffff;
		z-index: 99999;
		display: flex;
		align-items: center;
		justify-content: center;
		transition: opacity 0.5s ease-out;
	}

	#pageLoader.loaded {
		opacity: 0;
		pointer-events: none;
	}

	body.loading {
		overflow: hidden !important;
		position: fixed !important;
		width: 100% !important;
		height: 100vh !important;
	}

	/* ================================
	LOADER CONTENT
	================================ */
	.loader-content {
		text-align: center;
		max-width: 520px;
		width: 100%;
	}

	.loader-icon {
		font-size: 60px;
		margin-bottom: -30px;
		animation: pulse 2s ease-in-out infinite;
	}

	@keyframes pulse {
		0%,100% { transform: scale(1); opacity: 1; }
		50% { transform: scale(1.1); opacity: 0.85; }
	}

	.loader-title {
		font-size: 20px;
		font-weight: bold;
		color: #1779ba;
		margin-bottom: 10px;
	}

	.loader-subtitle {
		margin-bottom: 5px;
		font-size: 15px;
		color: #8a8a8a;
	}

	/* ================================
	PROGRESS BAR (FIXED & STABLE)
	================================ */
	.progress {
		overflow: hidden;
		background: #e6e6e6;
		height: 1rem;
		border-radius: 999px;
	}

	.progress-meter {
		position: relative;
		height: 100%;
		width: 0%;
		background: #1779ba;
		border-radius: inherit;
		overflow: hidden;
		transition: width 0.4s ease;
		will-change: width;
	}

	/* SHIMMER FIXED WIDTH */
	.progress-meter::before {
		content: '';
		position: absolute;
		top: 0;
		left: -40%;
		width: 40%;
		height: 100%;
		background: linear-gradient(
			90deg,
			transparent,
			rgba(255,255,255,0.4),
			transparent
		);
		animation: shimmer 1.5s infinite;
	}

	@keyframes shimmer {
		0% { transform: translateX(0); }
		100% { transform: translateX(300%); }
	}

	/* ================================
	PROGRESS ROW
	================================ */
	.progress-row {
		width: 400px;
		max-width: 90vw;
		display: flex;
		margin: auto;
		align-items: center;
		gap: 12px;
	}

	.progress-row .progress {
		flex: 1;
		margin-bottom: 0;
	}

	.loader-percentage {
		font-size: 22px;
		font-weight: bold;
		color: #1779ba;
		white-space: nowrap;
		text-align: right;
		margin-top: -3px;
	}

	/* ================================
	LOADER STATUS
	================================ */
	.loader-status {
		font-size: 15px;
		color: #1779ba;
		font-weight: 500;
		min-height: 20px;
	}

	/* ================================
	COUNTDOWN LOADING
	================================ */
	#countdownLoading {
		position: fixed;
		inset: 0;
		z-index: 999999;
		background: rgba(0,0,0,0.45);
		backdrop-filter: blur(2px);
		display: none;
		align-items: center;
		justify-content: center;
	}

	#countdownLoading .loader-content {
		background: #ffffff;
		border-radius: 8px;
		box-shadow: 0 12px 30px rgba(0,0,0,0.3);
		padding: 20px;
	}

	#countdownLoading .loader-title {
		font-size: 20px;
		font-weight: bold;
		color: #1779ba;
		text-align: center;
		margin-bottom: 10px;
	}

	#countdownLoading .loader-percentage {
		margin-top: -3px;
		font-size: 22px;
	}

	/* ================================
	TOAST
	================================ */
	.toast {
		position: fixed;
		top: -100px;
		left: 50%;
		transform: translateX(-50%);
		z-index: 999999;
		min-width: 300px;
		max-width: 90vw;
		text-align: center;
		transition: top 0.5s ease-in-out;
	}

	.toast.show {
		top: 30px;
	}
	</style>

</head>

<body>
	<!-- Page Loading Screen -->
	<div id="pageLoader">
		<div class="grid-container full">
			<div class="grid-x grid-padding-x grid-margin-y align-center">
				<div class="medium-12 small-12 large-12 cell">
					<div class="loader-content">
						<div class="grid-x grid-padding-y">
							<div class="medium-12 small-12 large-12 cell">
								<div class="loader-icon">üïå</div>
							</div>
							<div class="medium-12 small-12 large-12 cell">
								<div class="loader-title">Jadwal Shalat</div>
							</div>
						</div>
						<div class="grid-x grid-padding-x">
							<div class="medium-12 small-12 large-12 cell">
								<div class="loader-subtitle">Memuat halaman...</div>
							</div>
							<div class="medium-12 small-12 large-12 cell">
								<div class="progress-row">
									<div class="progress" role="progressbar" tabindex="0"
										aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
										<div class="progress-meter" id="loadingProgress"></div>
									</div>
									<div class="loader-percentage" id="loadingPercentage">0%</div>
								</div>
							</div>
							<div class="medium-12 small-12 large-12 cell">
								<div class="loader-status" id="loadingStatus">Mohon tunggu...</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- Toast Notification using Foundation Callout -->
	<div id="toast" class="toast callout success"></div>
	<!-- Countdown Loading Bar (Like Page Loader) -->
	<div  id="countdownLoading" style="display: none;">
		<div class="grid-container full">
			<div class="grid-x grid-padding-x grid-margin-y align-center">
				<div class="medium-12 small-12 large-12 cell">
					<div class="loader-content">
						<div class="grid-x grid-padding-x">
							<div class="medium-12 small-12 large-12 cell">
								<div class="loader-title" id="countdownTitle">Mulai</div>
							</div>
							<div class="medium-12 small-12 large-12 cell">
								<div class="progress-row">
									<div class="progress" role="progressbar" tabindex="0"
										aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
										<div class="progress-meter" id="countdownProgressBar"></div>
									</div>
									<div class="loader-percentage" id="countdownPercentage">0%</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="grid-container">
		<div class="grid-x grid-padding-x grid-margin-y align-center">
			<div class="medium-10 small-12 large-10 cell">
				<!-- Header -->
				<div class="grid-x grid-padding-y">
					<div class="medium-12 small-12 large-12 text-center cell">
						<h3>üïå Jadwal Shalat</h3>
						<p class="subheader">Pengaturan otomatis melalui WiFi</p>
					</div>
				</div>
				<div class="medium-12 small-12 large-12 cell">
					<ul class="tabs" data-tabs id="example-tabs">
						<li class="tabs-title is-active">
							<a href="#home" aria-selected="true">BERANDA</a>
						</li>
						<li class="tabs-title">
							<a href="#wifi">WIFI</a>
						</li>
						<li class="tabs-title">
							<a href="#time">WAKTU</a>
						</li>
						<li class="tabs-title">
							<a href="#location">LOKASI</a>
						</li>
						<li class="tabs-title">
							<a href="#prayer">JADWAL</a>
						</li>
						<li class="tabs-title">
							<a href="#factory">RESET</a>
						</li>
					</ul>
				</div>
				<div class="tabs-content" data-tabs-content="example-tabs">
					<div class="tabs-panel is-active" id="home">
						<div class="grid-x grid-padding-x">
							<div class="medium-12 small-12 large-12 text-center cell">
								<div class="callout">
									<div class="grid-x grid-margin-x grid-margin-y">
										<div class="medium-12 small-12 large-12 cell">
											<div class="grid-x grid-padding-y">
												<div class="medium-12 small-12 large-12 text-center cell">
													<h5>
														<strong>üìä Status Perangkat</strong>
													</h5>
												</div>
											</div>
											<div class="grid-x grid-margin-x">
												<div class="medium-6 small-12 large-6 cell text-left">
													<p>
														<strong>Jaringan WiFi:</strong>
														<span id="wifiName">-</span>
													</p>
													<p>
														<strong>Alamat IP:</strong>
														<span id="ipAddress">-</span>
													</p>
													<p>
														<strong>Internet:</strong>
														<span id="internetStatus"
															class="label warning">Menghubungkan‚Ä¶</span>
													</p>
												</div>
												<div class="medium-6 small-12 large-6 cell text-left">
													<p>
														<strong>Status NTP:</strong>
														<span id="ntpStatus">-</span>
													</p>
													<p>
														<strong>Server NTP:</strong>
														<span id="ntpServerUsed">-</span>
													</p>
													<p>
														<strong>Waktu:</strong>
														<span id="currentTime">00:00:00</span>
													</p>
													<p>
														<strong>Tanggal:</strong>
														<span id="currentDate">01/01/2000</span>
													</p>
													<p>
														<strong>Waktu Aktif:</strong>
														<span id="uptime">00:00:00</span>
													</p>
												</div>
												<div class="medium-12 small-12 large-12 cell">
													<button class="button secondary expanded" onclick="restartDevice()">
														Mulai Ulang Perangkat </button>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="tabs-panel" id="wifi">
						<div class="grid-x grid-padding-x">
							<div class="medium-12 small-12 large-12 text-center cell">
								<div class="callout">
									<div class="grid-x grid-margin-x grid-margin-y align-center ">
										<div class="medium-6 small-12 large-6 cell">
											<div class="grid-x grid-padding-x">
												<div class="medium-12 small-12 large-12 cell">
													<div class="grid-x grid-padding-y">
														<div class="medium-12 small-12 large-12 text-center cell">
															<h5>
																<strong>üì° WiFi Router</strong>
															</h5>
														</div>
													</div>
													<div class="grid-x grid-margin-x">
														<div class="medium-12 small-12 large-12 cell">
															<label>SSID WiFi Router</label>
															<input type="text" id="wifiSSID"
																placeholder="Masukkan SSID WiFi" autocomplete="off"
																data-form="wifi-credentials">
														</div>
														<div class="medium-12 small-12 large-12 cell">
															<label>Password WiFi</label>
															<input type="password" id="wifiPassword"
																placeholder="Masukkan password WiFi"
																autocomplete="new-password"
																data-form="wifi-credentials">
														</div>
														<div class="medium-6 small-6 large-6 cell">
															<button class="button secondary expanded"
																onclick="setWiFi()"> Simpan </button>
														</div>
														<div class="medium-6 small-6 large-6 cell">
															<button class="button secondary expanded"
																onclick="clearWiFiForm()"> Batal </button>
														</div>
													</div>
												</div>
											</div>
										</div>
										<div class="medium-6 small-12 large-6 cell">
											<div class="grid-x grid-padding-y">
												<div class="medium-12 small-12 large-12 text-center cell">
													<h5>
														<strong>üì∂ Access Point</strong>
													</h5>
												</div>
											</div>
											<div class="grid-x grid-margin-x">
												<div class="medium-12 small-12 large-12 cell">
													<label>SSID Access Point</label>
													<input type="text" id="apSSID" placeholder="Masukkan SSID AP"
														autocomplete="off" data-form="ap-credentials">
												</div>
												<div class="medium-12 small-12 large-12 cell">
													<label>Password Access Point</label>
													<input type="password" id="apPassword"
														placeholder="Masukkan password AP (minimal 8 karakter)"
														autocomplete="new-password" data-form="ap-credentials">
												</div>
												<div class="medium-6 small-6 large-6 cell">
													<button class="button secondary expanded" onclick="setAP()"> Simpan
													</button>
												</div>
												<div class="medium-6 small-6 large-6 cell">
													<button class="button secondary expanded" onclick="clearAPForm()">
														Batal </button>
												</div>
											</div>
										</div>
										<div class="medium-6 small-12 large-6 cell">
											<div class="grid-x grid-padding-y">
												<div class="medium-12 small-12 large-12 text-center cell">
													<h5>
														<strong>üåê Konfigurasi Jaringan Access Point</strong>
													</h5>
												</div>
											</div>
											<div class="grid-x grid-margin-x">
												<div class="medium-12 small-12 large-12 cell">
													<label>IP Address Access Point</label>
													<input type="text" id="apIP" placeholder="192.168.4.1"
														autocomplete="off" data-form="network-config">
												</div>
												<div class="medium-12 small-12 large-12 cell">
													<label>Gateway</label>
													<input type="text" id="gatewayIP" placeholder="192.168.4.1"
														autocomplete="off" data-form="network-config">
												</div>
												<div class="medium-12 small-12 large-12 cell">
													<label>Subnet Mask</label>
													<input type="text" id="subnetMask" placeholder="255.255.255.0"
														autocomplete="off" data-form="network-config">
												</div>
												<div class="medium-6 small-6 large-6 cell">
													<button class="button secondary expanded"
														onclick="setAPNetwork()">Simpan</button>
												</div>
												<div class="medium-6 small-6 large-6 cell">
													<button class="button secondary expanded"
														onclick="clearDHCPForm()">Batal</button>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="tabs-panel" id="time">
						<div class="grid-x grid-padding-x">
							<div class="medium-12 small-12 large-12 text-center cell">
								<div class="callout">
									<div class="grid-x grid-margin-x grid-margin-y">
										<div class="medium-12 small-12 large-12 cell">
											<div class="grid-x grid-padding-y">
												<div class="medium-12 small-12 large-12 text-center cell">
													<h5>
														<strong>Waktu & Sinkronisasi</strong>
													</h5>
												</div>
											</div>
											<div class="grid-x grid-margin-x align-middle">
												<div class="medium-6 small-12 large-6 cell">
													<div class="callout secondary">
														<div class="medium-12 small-12 large-12 cell">
															<h6>
																<strong>üì± Pembaruan Manual</strong>
															</h6>
															<p class="help-text">Perbarui waktu dari perangkat Anda</p>
														</div>
														<div class="medium-12 small-12 large-12 cell">
															<button class="button secondary expanded"
																onclick="syncTime()"> Perbarui Waktu </button>
														</div>
													</div>
												</div>
												<div class="medium-6 small-12 large-6 cell">
													<div class="callout secondary">
														<div class="medium-12 small-12 large-12 cell">
															<h6>
																<strong>üåê Pembaruan Otomatis (NTP) <span
																		class="label success">AUTO</span>
																</strong>
															</h6>
															<p class="help-text">Waktu diperbarui otomatis saat
																terhubung ke internet</p>
														</div>
														<div class="medium-12 small-12 large-12 cell">
															<p class="help-text"> üîÑ Perbarui otomatis setiap 1 jam <br>
																üóÑÔ∏è Beberapa server cadangan <br> üåê Zona waktu: UTC
																<span id="timezoneDisplayText">+7</span>
																<input type="text" id="timezoneInput" value="+7"
																	style="display: none; width: 60px; height: 25px; padding: 2px 5px; margin: 0 5px; text-align: center; font-weight: bold;"
																	pattern="^[+-]?\d+$" maxlength="3">
																<button id="timezoneBtn" onclick="toggleTimezoneEdit()"
																	style="margin-left: -5px; padding: 5px 10px; line-height: 1;"
																	title="Edit Zona Waktu"> üïê </button>
																<button id="timezoneCancelBtn"
																	onclick="cancelTimezoneEdit()"
																	style="display: none; margin-left: -5px; padding: 5px 10px; line-height: 1;"
																	title="Batal Edit"> ‚úñ </button>
															</p>
															<p class="help-text"
																style="margin-top: 5px; font-size: 11px; color: #666;">
																üáÆüá© WIB = +7 | WITA = +8 | WIT = +9 <br>
															</p>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="tabs-panel" id="location">
						<div class="grid-x grid-padding-x">
							<div class="medium-12 small-12 large-12 text-center cell">
								<div class="callout">
									<div class="grid-x grid-margin-x grid-margin-y">
										<div class="medium-12 small-12 large-12 cell">
											<div class="grid-x grid-padding-y">
												<div class="medium-12 small-12 large-12 text-center cell">
													<h5>
														<strong>üïå Lokasi & Metode Kalkulasi</strong>
													</h5>
												</div>
											</div>
											<div class="grid-x grid-margin-x">
												<div class="medium-12 small-12 large-12 cell">
													<div class="callout secondary">
														<p>
															<strong>Lokasi Terpilih:</strong>
														</p>
														<h4 id="currentCity" class="text-primary">Pilih lokasi</h4>
														<p id="currentCityType" class="help-text"
															style="margin-top: -10px; font-size: 13px; color: #666;">
															<span id="cityTypeLabel"></span>
														</p>
														<p>
															<strong>Metode:</strong>
															<span id="currentMethodTop">Egyptian General Authority of
																Survey</span>
														</p>
													</div>
												</div>
											</div>
											<div class="grid-x grid-margin-x">
												<div class="medium-8 small-12 large-9 cell">
													<label>Pilih Lokasi</label>
													<select id="cityDropdown" onchange="handleCityChange()">
														<option value="">-- Pilih lokasi --</option>
													</select>
												</div>
												<div class="medium-4 small-12 large-3 cell">
													<label class="show-for-medium">&nbsp;</label>
													<button class="button secondary expanded" onclick="saveCity()">
														Simpan </button>
												</div>
												<div id="coordinatesForm" class="medium-12 small-12 large-12 cell hide">
													<div class="grid-x grid-padding-y">
														<div class="medium-12 small-12 large-12 text-center cell">
															<h5>
																<strong>üìç Ubah Koordinat</strong>
															</h5>
															<p class="help-text">Sesuaikan koordinat jika diperlukan</p>
														</div>
													</div>
													<div class="grid-x grid-margin-x">
														<div class="medium-6 small-12 large-6 cell">
															<label>Latitude (Lintang)</label>
															<input type="text" id="latInput" placeholder="-6.2088"
																pattern="^-?\d+\.?\d*$">
															<p class="help-text">Contoh: -6.2088</p>
														</div>
														<div class="medium-6 small-12 large-6 cell">
															<label>Longitude (Bujur)</label>
															<input type="text" id="lonInput" placeholder="106.8456"
																pattern="^-?\d+\.?\d*$">
															<p class="help-text">Contoh: 106.8456</p>
														</div>
														<div class="medium-6 small-6 large-6 cell">
															<button class="button secondary expanded"
																onclick="resetToDefaultCoordinates()"
																title="Reset ke koordinat dari JSON"> Reset </button>
														</div>
														<div class="medium-6 small-6 large-6 cell">
															<button class="button secondary expanded"
																onclick="cancelCoordinatesEdit()"
																title="Batalkan perubahan koordinat"> Batal </button>
														</div>
													</div>
													<div class="grid-x grid-margin-x">
														<div class="medium-12 small-12 large-12 cell">
															<div class="callout secondary">
																<p class="help-text"> üìç Koordinat <span
																		id="defaultCoords">-</span>
																	<br> üßÆ Gunakan format angka dengan titik desimal
																	<br> üåê Latitude: -90 hingga 90 | Longitude: -180
																	hingga 180
																</p>
															</div>
														</div>
													</div>
												</div>
												<div class="medium-8 small-12 large-9 cell">
													<label>Metode Kalkulasi Jadwal Shalat</label>
													<select id="methodDropdown">
														<option value="20">Kementerian Agama Indonesia (Kemenag)
														</option>
														<option value="3">Muslim World League (MWL)</option>
														<option value="5" selected>Egyptian General Authority of Survey
														</option>
														<option value="2">Islamic Society of North America (ISNA)
														</option>
														<option value="0">Shia Ithna-Ashari</option>
														<option value="1">University of Islamic Sciences, Karachi
														</option>
														<option value="4">Umm Al-Qura University, Makkah</option>
														<option value="7">Institute of Geophysics, University of Tehran
														</option>
													</select>
												</div>
												<div class="medium-4 small-12 large-3 cell">
													<label class="show-for-medium">&nbsp;</label>
													<button class="button secondary expanded" onclick="saveMethod()">
														Simpan </button>
												</div>
											</div>
											<div class="grid-x grid-margin-x">
												<div class="medium-12 small-12 large-12 cell">
													<div class="callout secondary">
														<p class="help-text"> üìç Pilih lokasi untuk menghitung jadwal
															shalat <br> üìê Pilih metode perhitungan yang diinginkan <br>
															üîÑ Jadwal akan diperbarui otomatis setelah memilih lokasi
														</p>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="medium-12 small-12 large-12 text-center cell">
								<div class="callout">
									<div class="grid-x grid-margin-x grid-margin-y">
										<div class="medium-12 small-12 large-12 cell">
											<div class="grid-x grid-padding-y">
												<div class="medium-12 small-12 large-12 text-center cell">
													<h5>
														<strong>üìç Perbarui Lokasi</strong>
													</h5>
												</div>
											</div>
											<div class="grid-x grid-margin-x">
												<div class="medium-12 small-12 large-12 cell">
													<div class="callout secondary">
														<p>
															<strong>Kapan perlu unggah cities.json?</strong>
															<br>
														</p>
														<p>
														<div class="help-text"> ‚ûï Ada lokasi baru yang ditambahkan <br>
															üìç Data koordinat lokasi ada yang diperbarui <br> Berkas
															<code>cities.json</code> rusak atau hilang </div>
														</p>
													</div>
												</div>
											</div>
											<div class="medium-8 small-12 large-8 cell">
												<label for="citiesFileInput" class="button hollow expanded"> üìÅ Pilih
													berkas cities.json <input type="file" id="citiesFileInput"
														accept=".json" class="show-for-sr"
														onchange="handleCitiesFileSelect(event)">
												</label>
												<p id="selectedFileName" class="help-text"> Belum ada berkas yang
													dipilih </p>
											</div>
											<div class="medium-4 small-12 large-4 cell">
												<button id="uploadBtn" class="button primary expanded"
													onclick="uploadCitiesFile()" disabled> üì§ Unggah Berkas </button>
												<button id="clearFileBtn" class="button primary expanded"
													onclick="clearSelectedFile()"
													style="display: none; margin-top: 10px;"> ‚úñ Batal </button>
											</div>
											<div id="uploadProgress" class="hide">
												<div class="progress" role="progressbar">
													<div id="uploadProgressBar" class="progress-meter"
														style="width: 0%">
														<p class="progress-meter-text">0%</p>
													</div>
												</div>
												<p id="uploadStatus" class="help-text"> Mulai mengunggah‚Ä¶ </p>
											</div>
											<div class="grid-x grid-margin-x">
												<div class="medium-12 small-12 large-12 cell">
													<div class="callout secondary">
														<p>
															<strong>Penting</strong>
														</p>
														<p class="help-text"> üìÑ Nama berkas harus
															<code>cities.json</code>
															<br> üßæ Format harus valid JSON array <br> üì¶ Ukuran
															maksimal: 1 MB <br> üîÑ Dropdown lokasi akan otomatis
															diperbarui setelah berhasil
														</p>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="tabs-panel" id="prayer">
						<div class="grid-x grid-padding-x">
							<div class="medium-12 small-12 large-12 text-center cell">
								<div class="callout">
									<div class="grid-x grid-margin-x grid-margin-y">
										<div class="medium-12 small-12 large-12 cell">
											<div class="grid-x grid-padding-y">
												<div class="medium-12 small-12 large-12 text-center cell">
													<h5>
														<strong>üïå Jadwal Shalat</strong>
													</h5>
												</div>
											</div>
											<div class="grid-x grid-margin-x">
												<div class="medium-12 small-12 large-12 cell">
													<div class="callout secondary" id="prayerTimesBox">
														<table class="unstriped hover">
															<tbody>
																<tr>
																	<td class="text-left">
																		<div class="switch tiny">
																			<strong>üåô Imsak</strong>
																			<input class="switch-input buzzer-toggle"
																				id="toggle-imsak" type="checkbox"
																				name="buzzer-imsak" data-prayer="imsak">
																			<label class="switch-paddle"
																				for="toggle-imsak">
																				<span class="switch-active"
																					aria-hidden="true">ON</span>
																				<span class="switch-inactive"
																					aria-hidden="true">OFF</span>
																			</label>
																		</div>
																	</td>
																	<td class="text-right">
																		<h5 id="imsakTime">00:00</h5>
																	</td>
																</tr>
																<tr>
																	<td class="text-left">
																		<div class="switch tiny">
																			<strong>üåÖ Subuh</strong>
																			<input class="switch-input buzzer-toggle"
																				id="toggle-subuh" type="checkbox"
																				name="buzzer-subuh" data-prayer="subuh">
																			<label class="switch-paddle"
																				for="toggle-subuh">
																				<span class="switch-active"
																					aria-hidden="true">ON</span>
																				<span class="switch-inactive"
																					aria-hidden="true">OFF</span>
																			</label>
																		</div>
																	</td>
																	<td class="text-right">
																		<h5 id="subuhTime">00:00</h5>
																	</td>
																</tr>
																<tr>
																	<td class="text-left">
																		<div class="switch tiny">
																			<strong>üåÑ Terbit</strong>
																			<input class="switch-input buzzer-toggle"
																				id="toggle-terbit" type="checkbox"
																				name="buzzer-terbit"
																				data-prayer="terbit">
																			<label class="switch-paddle"
																				for="toggle-terbit">
																				<span class="switch-active"
																					aria-hidden="true">ON</span>
																				<span class="switch-inactive"
																					aria-hidden="true">OFF</span>
																			</label>
																		</div>
																	</td>
																	<td class="text-right">
																		<h5 id="terbitTime">00:00</h5>
																	</td>
																</tr>
																<tr>
																	<td class="text-left">
																		<div class="switch tiny">
																			<strong>‚òÄÔ∏è Zuhur</strong>
																			<input class="switch-input buzzer-toggle"
																				id="toggle-zuhur" type="checkbox"
																				name="buzzer-zuhur" data-prayer="zuhur">
																			<label class="switch-paddle"
																				for="toggle-zuhur">
																				<span class="switch-active"
																					aria-hidden="true">ON</span>
																				<span class="switch-inactive"
																					aria-hidden="true">OFF</span>
																			</label>
																		</div>
																	</td>
																	<td class="text-right">
																		<h5 id="zuhurTime">00:00</h5>
																	</td>
																</tr>
																<tr>
																	<td class="text-left">
																		<div class="switch tiny">
																			<strong>üå§Ô∏è Ashar</strong>
																			<input class="switch-input buzzer-toggle"
																				id="toggle-ashar" type="checkbox"
																				name="buzzer-ashar" data-prayer="ashar">
																			<label class="switch-paddle"
																				for="toggle-ashar">
																				<span class="switch-active"
																					aria-hidden="true">ON</span>
																				<span class="switch-inactive"
																					aria-hidden="true">OFF</span>
																			</label>
																		</div>
																	</td>
																	<td class="text-right">
																		<h5 id="asharTime">00:00</h5>
																	</td>
																</tr>
																<tr>
																	<td class="text-left">
																		<div class="switch tiny">
																			<strong>üåÜ Maghrib</strong>
																			<input class="switch-input buzzer-toggle"
																				id="toggle-maghrib" type="checkbox"
																				name="buzzer-maghrib"
																				data-prayer="maghrib">
																			<label class="switch-paddle"
																				for="toggle-maghrib">
																				<span class="switch-active"
																					aria-hidden="true">ON</span>
																				<span class="switch-inactive"
																					aria-hidden="true">OFF</span>
																			</label>
																		</div>
																	</td>
																	<td class="text-right">
																		<h5 id="maghribTime">00:00</h5>
																	</td>
																</tr>
																<tr>
																	<td class="text-left">
																		<div class="switch tiny">
																			<strong>üåô Isya</strong>
																			<input class="switch-input buzzer-toggle"
																				id="toggle-isya" type="checkbox"
																				name="buzzer-isya" data-prayer="isya">
																			<label class="switch-paddle"
																				for="toggle-isya">
																				<span class="switch-active"
																					aria-hidden="true">ON</span>
																				<span class="switch-inactive"
																					aria-hidden="true">OFF</span>
																			</label>
																		</div>
																	</td>
																	<td class="text-right">
																		<h5 id="isyaTime">00:00</h5>
																	</td>
																</tr>
															</tbody>
														</table>
														<!-- Volume Control - Native HTML5 Slider -->
														<div class="medium-12 small-12 large-12 cell"
															style="margin-top: 20px;">
															<strong>üîä VOLUME BUZZER</strong>
															<div
																style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
																<span>0</span>
																<input type="range" id="volumeSlider" min="0" max="100"
																	value="50" style="flex: 1;">
																<span>100</span>
																<span id="volumeValue"
																	style="font-weight: bold; color: #1779ba;">50%</span>
															</div>
															<div style="margin-top: 15px;">
																<button id="testBuzzerBtn" class="button secondary" 
																	onclick="toggleTestBuzzer()">
																	üîî Test Buzzer
																</button>
															</div>
														</div>
													</div>
												</div>
											</div>
											<div class="grid-x grid-margin-x">
												<div class="medium-12 small-12 large-12 cell">
													<div class="callout secondary">
														<p class="help-text"> üïå Jadwal shalat berdasarkan lokasi yang
															dipilih <br> üîÑ Diperbarui otomatis setiap tengah malam <br>
															üìê <span id="currentMethodBottom">Egyptian General Authority
																of Survey</span>
															<br> ‚ö° Diperbarui otomatis saat terhubung ke internet
														</p>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="tabs-panel" id="factory">
						<div class="grid-x grid-padding-x">
							<div class="medium-12 small-12 large-12 text-center cell">
								<div class="callout">
									<div class="grid-x grid-margin-x grid-margin-y">
										<div class="medium-12 small-12 large-12 cell">
											<div class="grid-x grid-padding-y">
												<div class="medium-12 small-12 large-12 text-center cell">
													<h5>
														<strong>üîÑ Setelan</strong>
													</h5>
												</div>
											</div>
											<div class="grid-x grid-margin-x">
												<div class="medium-12 small-12 large-12 cell">
													<div class="callout secondary">
														<p>
															<strong>Peringatan</strong> Tindakan ini akan menghapus
															seluruh data dan tidak dapat dibatalkan
														</p>
														<p class="help-text"> üì∂ kredensial WiFi </br> üì° Konfigurasi
															Access Point </br> üïå Jadwal shalat tersimpan </br> üìç
															Lokasi yang dipilih </br> Waktu dan tanggal </br>
														</p>
													</div>
												</div>
											</div>
											<div class="medium-12 small-12 large-12 cell">
												<button class="button secondary expanded" onclick="resetSettings()">
													Reset </button>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="grid-x grid-padding-y">
					<div class=" medium-12 small-12 large-12 text-center cell">
						<h6>
							<strong>GONIT: GLOBAL NETWORK IDENTIFICATION TECHNOLOGY</strong>
						</h6>
						<span id="tahun"></span>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
		const tahunAwal = 2025;
		const tahunSekarang = new Date().getFullYear();

		document.getElementById("tahun").textContent =
			tahunAwal + " - " + tahunSekarang;

		// ================================
		// LOADING MANAGER
		// ================================
		const LoadingManager = {
			totalSteps: 2,
			currentStep: 0,
			steps: [{
				name: 'UI',
				progress: 0
			}, {
				name: 'Action',
				progress: 50
			}],
			updateProgress(stepIndex, statusText) {
				const progress = this.steps[stepIndex].progress;
				const progressBar = document.getElementById('loadingProgress');
				const progressContainer = progressBar?.closest('.progress');
				const percentage = document.getElementById('loadingPercentage');
				const status = document.getElementById('loadingStatus');
				
				if (progressBar) progressBar.style.width = progress + '%';
				if (progressContainer) progressContainer.setAttribute('aria-valuenow', progress);
				if (percentage) percentage.textContent = progress + '%';
				if (status) status.textContent = statusText || this.steps[stepIndex].name;
			},
			completeLoading() {
				const loader = document.getElementById('pageLoader');
				const progressBar = document.getElementById('loadingProgress');
				const progressContainer = progressBar?.closest('.progress');
				const percentage = document.getElementById('loadingPercentage');
				const status = document.getElementById('loadingStatus');
				
				if (progressBar) progressBar.style.width = '100%';
				if (progressContainer) progressContainer.setAttribute('aria-valuenow', 100);
				if (percentage) percentage.textContent = '100%';
				if (status) status.textContent = 'Siap';
				
				setTimeout(() => {
					if (loader) {
						loader.classList.add('loaded');
						document.body.classList.remove('loading');
						setTimeout(() => {
							loader.style.display = 'none';
						}, 500);
					}
				}, 300);
			}
		};
		function forceRemoveLoadingState() {
			document.body.classList.remove('loading');
			document.body.style.overflow = '';
			document.body.style.height = '';
			document.body.style.maxHeight = '';
			document.body.style.position = '';
			document.body.style.width = '';
			document.body.style.top = '';
			document.body.style.left = '';

			const loader = document.getElementById('pageLoader');
			if (loader) {
				loader.style.display = 'none';
			}
		}
		const cssLoaded = new Promise((resolve) => {
			const checkCSS = setInterval(() => {
				const testDiv = document.createElement('div');
				testDiv.className = 'grid-container';
				document.body.appendChild(testDiv);
				const hasCSS = getComputedStyle(testDiv).width !== '100%';
				document.body.removeChild(testDiv);
				if (hasCSS) {
					clearInterval(checkCSS);
					resolve();
				}
			}, 50);
			setTimeout(() => {
				clearInterval(checkCSS);
				resolve();
			}, 5000);
		});
		// ================================
		// VARIABEL GLOBAL
		// ================================
		let isOnline = false;
		let cityList = [];
		let loadAttempts = 0;
		const MAX_LOAD_ATTEMPTS = 3;
		let buzzerTestInterval = null;
		let isUserLocalAP = true;
		let isLoadingDeviceStatus = false;
		let isLoadingPrayerTimes = false;
		let isLoadingMethod = false;
		let serverTimestamp = 0;
		let localStartTime = 0;
		let serverUptimeStart = 0;
		let lastSyncTime = 0;
		let prayerConfig = {
			imsakTime: '00:00',
			subuhTime: '00:00',
			terbitTime: '00:00',
			zuhurTime: '00:00',
			asharTime: '00:00',
			maghribTime: '00:00',
			isyaTime: '00:00'
		};
		let methodConfig = {
			methodId: 5,
			methodName: 'Egyptian General Authority of Survey'
		};
		let defaultCoordinates = {
			lat: '',
			lon: ''
		};
		let timezoneConfig = {
			offset: 7
		};

		(function checkConnectionType() {
			fetch('/api/connection-type')
				.then(response => response.json())
				.then(data => {
					isUserLocalAP = data.isLocalAP;

				})
				.catch(error => {
					isUserLocalAP = true;
				});
		})();
		// ================================
		// TAB CLICK HANDLER - RELOAD SETIAP KALI
		// ================================
		function handleTabClick(tabName) {
			switch (tabName) {
				case 'home':
					loadHomeTab();
					break;
				case 'wifi':
					loadWiFiTab();
					break;
				case 'time':
					loadTimeTab();
					break;
				case 'location':
					loadCityTab();
					break;
				case 'prayer':
					loadPrayerTab();
					break;
				case 'factory':
					break;
				default:
			}
		}
		// ================================
		// LOAD HOME TAB DATA
		// ================================
		async function loadHomeTab() {
			try {
				await updateDeviceStatus();
			} catch (error) { }
		}
		// ================================
		// LOAD WIFI TAB DATA
		// ================================
		async function loadWiFiTab() {
			try {
				await loadWiFiConfig();
			} catch (error) { }
		}
		// ================================
		// LOAD TIME TAB DATA
		// ================================
		async function loadTimeTab() {
			try {
				await loadTimezoneConfig();
			} catch (error) { }
		}
		// ================================
		// LOAD CITY TAB DATA
		// ================================
		async function loadCityTab() {
			try {
				await loadCities();
				await loadCurrentCity();
				await loadCurrentMethod();
			} catch (error) { }
		}
		// ================================
		// LOAD PRAYER TAB DATA
		// ================================
		async function loadPrayerTab() {
			try {
				await loadSavedPrayerTimes();
				await loadCurrentMethod();
				await loadBuzzerConfig();
			} catch (error) { }
		}
		// ================================
		// HELPER: EXTRACT TYPE FROM DISPLAY NAME
		// ================================
		function extractLocationType(displayName) {
			if (!displayName) return null;
			const match = displayName.match(/\(([^)]+)\)$/);
			if (!match) return null;
			const typeInBracket = match[1].toLowerCase().trim();
			const typeMap = {
				'kota': {
					emoji: 'üèôÔ∏è',
					label: 'City'
				},
				'city': {
					emoji: 'üèôÔ∏è',
					label: 'City'
				},
				'kabupaten': {
					emoji: 'üèûÔ∏è',
					label: 'District'
				},
				'district': {
					emoji: 'üèòÔ∏è',
					label: 'District'
				},
				'kecamatan': {
					emoji: 'üèòÔ∏è',
					label: 'Sub-District'
				},
				'kelurahan': {
					emoji: 'üè°',
					label: 'Village'
				},
				'desa': {
					emoji: 'üè°',
					label: 'Village'
				}
			};
			return typeMap[typeInBracket] || {
				emoji: 'üìç',
				label: typeInBracket
			};
		}
		// ================================
		// FUNGSI WAKTU REAL-TIME
		// ================================
		function getCurrentTime() {
			if (serverTimestamp === 0 || localStartTime === 0) {
				return null;
			}
			const elapsedMs = Date.now() - localStartTime;
			const currentTimestamp = serverTimestamp + Math.floor(elapsedMs / 1000);
			return new Date(currentTimestamp * 1000);
		}

		function getCurrentUptime() {
			if (serverUptimeStart === 0 || localStartTime === 0) {
				return 0;
			}
			const elapsedMs = Date.now() - localStartTime;
			return serverUptimeStart + Math.floor(elapsedMs / 1000);
		}

		function formatTime(date) {
			if (!date) return '--:--:--';
			const hours = String(date.getHours()).padStart(2, '0');
			const minutes = String(date.getMinutes()).padStart(2, '0');
			const seconds = String(date.getSeconds()).padStart(2, '0');
			return `${hours}:${minutes}:${seconds}`;
		}

		function formatUptime(seconds) {
			if (seconds === 0) return '--:--:--';
			const days = Math.floor(seconds / 86400);
			const hours = Math.floor((seconds % 86400) / 3600);
			const minutes = Math.floor((seconds % 3600) / 60);
			const secs = seconds % 60;
			if (days > 0) {
				return `${days}h ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
			} else {
				return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
			}
		}

		function updateRealtimeDisplay() {
			const currentTime = getCurrentTime();
			const uptime = getCurrentUptime();
			const timeElement = document.getElementById('currentTime');
			const dateElement = document.getElementById('currentDate');
			const uptimeElement = document.getElementById('uptime');
			if (timeElement && currentTime) {
				const hours = String(currentTime.getHours()).padStart(2, '0');
				const minutes = String(currentTime.getMinutes()).padStart(2, '0');
				const seconds = String(currentTime.getSeconds()).padStart(2, '0');
				timeElement.textContent = `${hours}:${minutes}:${seconds}`;
			}
			if (dateElement && currentTime) {
				const day = String(currentTime.getDate()).padStart(2, '0');
				const month = String(currentTime.getMonth() + 1).padStart(2, '0');
				const year = currentTime.getFullYear();
				dateElement.textContent = `${day}/${month}/${year}`;
			}
			if (uptimeElement) {
				uptimeElement.textContent = formatUptime(uptime);
			}
		}
		// ================================
		// NOTIFIKASI TOAST
		// ================================
		function showToast(message, type = 'success') {
			const toast = document.getElementById('toast');
			toast.textContent = message;
			toast.className = 'toast callout';
			if (type === 'error') {
				toast.classList.add('alert');
			} else if (type === 'warning') {
				toast.classList.add('warning');
			} else {
				toast.classList.add('success');
			}
			toast.classList.add('show');
			setTimeout(() => {
				toast.classList.remove('show');
			}, 4000);
		}
		// ================================
		// COUNTDOWN MANAGER - SERVER-DRIVEN
		// ================================
		let isCountdownActive = false;
		let countdownEndTime = 0;
		let countdownReason = "";
		let countdownMessage = "";
		let countdownTotalSeconds = 0;
		let countdownCheckInterval = null;
		let lastKnownCountdownState = null;
		let lastSuccessfulPoll = Date.now();
		const POLL_TIMEOUT_MS = 10000;

		let countdownUIInterval = null;

		function startCountdownPolling() {
			if (countdownCheckInterval) {
				clearInterval(countdownCheckInterval);
			}

			lastSuccessfulPoll = Date.now();
			checkCountdownStatus();

			countdownCheckInterval = setInterval(() => {
				checkCountdownStatus();

				const timeSinceLastPoll = Date.now() - lastSuccessfulPoll;

				if (timeSinceLastPoll > POLL_TIMEOUT_MS && isCountdownActive) {
				}
			}, 1000);
		}

		function stopCountdownPolling() {
			if (countdownCheckInterval) {
				clearInterval(countdownCheckInterval);
				countdownCheckInterval = null;
			}
			if (countdownUIInterval) {
				clearInterval(countdownUIInterval);
				countdownUIInterval = null;
			}
		}

		async function checkCountdownStatus() {
			try {
				const controller = new AbortController();
				const timeoutId = setTimeout(() => controller.abort(), 2000);

				const response = await fetch('/api/countdown', {
					signal: controller.signal,
					cache: 'no-cache',
					headers: {
						'Cache-Control': 'no-cache',
						'Pragma': 'no-cache'
					}
				});

				clearTimeout(timeoutId);

				if (!response.ok) {
					throw new Error(`HTTP ${response.status}`);
				}

				const data = await response.json();

				lastSuccessfulPoll = Date.now();
				lastKnownCountdownState = data;

				if (data.active && data.remaining > 0) {

					if (!isCountdownActive) {
						const clientNow = Date.now();
						const bufferSeconds = 1;
						countdownEndTime = clientNow + ((data.remaining + bufferSeconds) * 1000);

						countdownReason = data.reason;
						countdownMessage = data.message;
						countdownTotalSeconds = data.total || data.remaining;

						startCountdownDisplay(data);
						startLocalCountdownTicker();
					} else {
						const serverRemaining = data.remaining;
						const localRemaining = Math.max(0, Math.floor((countdownEndTime - Date.now()) / 1000));
						const drift = Math.abs(serverRemaining - localRemaining);

						if (drift > 3) {
							const clientNow = Date.now();
							countdownEndTime = clientNow + (serverRemaining * 1000);
						}
					}
				}
				else if (data.active === false && isCountdownActive) {
					stopCountdownDisplay();
					return;
				}

			} catch (error) {
				const timeSinceLastPoll = Date.now() - lastSuccessfulPoll;

				if (timeSinceLastPoll > POLL_TIMEOUT_MS) {
				}

				if (error.name === 'AbortError') {
				} else {
				}
			}
		}

		function startLocalCountdownTicker() {
			if (countdownUIInterval) {
				clearInterval(countdownUIInterval);
			}

			countdownUIInterval = setInterval(() => {
				if (!isCountdownActive) return;

				const remaining = Math.max(
					0,
					Math.ceil((countdownEndTime - Date.now()) / 1000)
				);

				updateCountdownDisplay(remaining, countdownMessage);

				if (remaining <= 0) {
					stopCountdownDisplay();
				}
			}, 100);
		}

		function startCountdownDisplay(data) {
			if (isCountdownActive) return;

			isCountdownActive = true;
			document.body.classList.add('countdown-active');

			// Show loading bar
			const loadingBar = document.getElementById('countdownLoading');
			const titleElement = document.getElementById('countdownTitle');

			if (titleElement) {
				titleElement.textContent = data.message || 'Memulai ulang proses';
			}

			loadingBar.style.display = 'flex';
		}
		function updateCountdownDisplay(remaining, message) {
			const loadingBar = document.getElementById('countdownLoading');
			const progressBar = document.getElementById('countdownProgressBar');
			const progressContainer = progressBar?.closest('.progress');
			const percentageElement = document.getElementById('countdownPercentage');
			const titleElement = document.getElementById('countdownTitle');

			if (!loadingBar) return;

			const now = Date.now();
			const elapsedMs = countdownTotalSeconds * 1000 - (countdownEndTime - now);
			const percentage = Math.min(100, Math.max(0, Math.round((elapsedMs / (countdownTotalSeconds * 1000)) * 100)));

			if (progressBar) progressBar.style.width = percentage + '%';
			if (progressContainer) progressContainer.setAttribute('aria-valuenow', percentage);
			if (percentageElement) percentageElement.textContent = percentage + '%';
			if (titleElement) titleElement.textContent = message;

			loadingBar.style.display = 'flex';
		}
		function stopCountdownDisplay() {
			if (!isCountdownActive) return;

			stopCountdownPolling();
			forceRedirect();
			isCountdownActive = false;
		}
		// ================================
		// FORCE REDIRECT - MERCUSYS STYLE
		// ================================
		function forceRedirect() {
			let targetURL = window.location.href;

			const currentIP = window.location.hostname;
			const isLocalAP = (currentIP.startsWith('192.168.4.') || currentIP === '192.168.4.1');

			if (countdownReason === 'factory_reset') {
				if (isLocalAP) {
					targetURL = 'http://192.168.4.1';
				} else {
					targetURL = window.location.href;
				}

			} else if (countdownReason === 'ap_restart') {
				if (isLocalAP) {
					const newIPInput = document.getElementById('apIP');
					const newIP = newIPInput ? newIPInput.value.trim() : '';

					if (newIP && newIP !== currentIP) {
						targetURL = `http://${newIP}`;
					} else {
						targetURL = window.location.href;
					}
				} else {
					targetURL = window.location.href;
				}

			} else if (countdownReason === 'device_restart') {
				targetURL = window.location.href;
			} else {
			}
			window.location.href = targetURL;
		}
		// ================================
		// DEVICE STATUS UPDATE
		// ================================
		async function updateDeviceStatus() {
			if (isLoadingDeviceStatus) {
				return;
			}
			isLoadingDeviceStatus = true;
			try {
				const response = await fetch('/devicestatus');
				const data = await response.json();
				isOnline = data.connected === true;
				document.getElementById('wifiName').textContent = data.ssid || 'Tidak Terhubung';
				document.getElementById('ipAddress').textContent = data.ip || '-';
				document.getElementById('ntpStatus').textContent = data.ntpSynced ? 'Tersinkron' : 'Belum tersinkron';
				if (document.getElementById('ntpServerUsed')) {
					document.getElementById('ntpServerUsed').textContent = data.ntpServer || '-';
				}
				const statusBadge = document.getElementById('internetStatus');
				if (isOnline) {
					statusBadge.textContent = 'Terhubung';
					statusBadge.className = 'label success';
				} else {
					statusBadge.textContent = 'Tidak terhubung';
					statusBadge.className = 'label alert';
				}
				// ================================
				// UPDATE TIME & DATE FROM SERVER
				// ================================
				if (data.currentTime && data.currentDate) {
					const timeParts = data.currentTime.split(':');
					const dateParts = data.currentDate.split('/');
					if (timeParts.length === 3 && dateParts.length === 3) {
						const now = new Date(parseInt(dateParts[2]), parseInt(dateParts[1]) - 1, parseInt(dateParts[0]), parseInt(timeParts[0]), parseInt(timeParts[1]), parseInt(timeParts[2]));
						serverTimestamp = Math.floor(now.getTime() / 1000);
						localStartTime = Date.now();
						lastSyncTime = Date.now();
					}
				}
				if (data.uptime !== undefined) {
					serverUptimeStart = data.uptime;
				}
			} catch (error) {
				isOnline = false;
				document.getElementById('internetStatus').textContent = 'Terjadi kesalahan';
				document.getElementById('internetStatus').className = 'label alert';
			} finally {
				isLoadingDeviceStatus = false;
			}
		}
		// ================================
		// LOAD LOCATION FUNCTION
		// ================================
		async function loadCities() {
			const dropdown = document.getElementById('cityDropdown');
			dropdown.innerHTML = '<option value="">Sedang memuat lokasi...</option>';
			try {
				const controller = new AbortController();
				const timeoutId = setTimeout(() => controller.abort(), 15000);
				const response = await fetch('/getcities', {
					method: 'GET',
					signal: controller.signal,
					headers: {
						'Accept': 'application/json',
						'Cache-Control': 'no-cache'
					}
				});
				clearTimeout(timeoutId);
				if (!response.ok) {
					throw new Error(`HTTP ${response.status}: ${response.statusText}`);
				}
				const data = await response.json();
				if (!Array.isArray(data) || data.length === 0) {
					throw new Error('Daftar lokasi tidak valid atau kosong');
				}
				cityList = data;
				dropdown.innerHTML = '<option value="">-- Pilih lokasi --</option>';
				let currentProvince = '';
				data.forEach(city => {
					if (city.province !== currentProvince) {
						currentProvince = city.province;
						const optgroup = document.createElement('optgroup');
						optgroup.label = '‚îå‚îÄ ' + currentProvince + ' ‚îÄ‚îê';
						dropdown.appendChild(optgroup);
					}
					const option = document.createElement('option');
					option.value = city.api;
					let displayText = city.display;
					if (city.lat && city.lon) {
						displayText += ` (${parseFloat(city.lat).toFixed(2)}¬∞, ${parseFloat(city.lon).toFixed(2)}¬∞)`;
					}
					option.textContent = displayText;
					option.setAttribute('data-lat', city.lat);
					option.setAttribute('data-lon', city.lon);
					const typeInfo = extractLocationType(city.display);
					if (typeInfo) {
						option.setAttribute('data-type', typeInfo.label);
						option.setAttribute('data-type-emoji', typeInfo.emoji);
					}
					const lastOptgroup = dropdown.querySelector('optgroup:last-of-type');
					if (lastOptgroup && lastOptgroup.label.includes(currentProvince)) {
						lastOptgroup.appendChild(option);
					} else {
						dropdown.appendChild(option);
					}
				});
				loadAttempts = 0;
				setTimeout(() => {
					loadCurrentCity();
				}, 100);
				return true;
			} catch (error) {
				loadAttempts++;
				if (loadAttempts < MAX_LOAD_ATTEMPTS) {
					const retryDelay = Math.min(2000 * Math.pow(2, loadAttempts), 10000);
					dropdown.innerHTML = `<option value="">Mencoba lagi (${loadAttempts}/${MAX_LOAD_ATTEMPTS})...</option>`;
					setTimeout(() => {
						loadCities();
					}, retryDelay);
				} else {
					dropdown.innerHTML = '<option value="">Gagal memuat lokasi - Silakan muat ulang halaman</option>';
					showToast('Gagal memuat daftar lokasi. Muat ulang halaman untuk mencoba lagi', 'error');
					loadAttempts = 0;
				}
				return false;
			}
		}

		// ================================
		// HANDLE CITY CHANGE FUNCTION
		// ================================
		function handleCityChange() {
			const dropdown = document.getElementById('cityDropdown');
			const selectedCity = dropdown.value;
			const coordinatesForm = document.getElementById('coordinatesForm');
			const latInput = document.getElementById('latInput');
			const lonInput = document.getElementById('lonInput');
			const defaultCoordsSpan = document.getElementById('defaultCoords');
			const cityTypeLabel = document.getElementById('cityTypeLabel');
			if (!selectedCity || selectedCity === '') {
				coordinatesForm.classList.add('hide');
				latInput.value = '';
				lonInput.value = '';
				defaultCoordinates.lat = '';
				defaultCoordinates.lon = '';
				defaultCoordsSpan.textContent = '-';
				if (cityTypeLabel) cityTypeLabel.textContent = '';
				return;
			}
			const selectedOption = dropdown.options[dropdown.selectedIndex];
			const lat = selectedOption.getAttribute('data-lat');
			const lon = selectedOption.getAttribute('data-lon');
			const typeLabel = selectedOption.getAttribute('data-type');
			const typeEmoji = selectedOption.getAttribute('data-type-emoji');
			if (cityTypeLabel && typeLabel && typeEmoji) {
				cityTypeLabel.textContent = `${typeEmoji} ${typeLabel}`;
			} else if (cityTypeLabel) {
				cityTypeLabel.textContent = '';
			}
			if (lat && lon) {
				defaultCoordinates.lat = lat;
				defaultCoordinates.lon = lon;
				coordinatesForm.classList.remove('hide');
				latInput.value = lat;
				lonInput.value = lon;
				defaultCoordsSpan.textContent = `${parseFloat(lat).toFixed(4)}¬∞, ${parseFloat(lon).toFixed(4)}¬∞`;
			} else {
				coordinatesForm.classList.add('hide');
			}
		}
		// ================================
		// RESET FUNCTION TO COORDINATES
		// ================================
		function resetToDefaultCoordinates() {
			const latInput = document.getElementById('latInput');
			const lonInput = document.getElementById('lonInput');
			if (!defaultCoordinates.lat || !defaultCoordinates.lon) {
				showToast('Tidak ada koordinat tersedia', 'warning');
				return;
			}
			latInput.value = defaultCoordinates.lat;
			lonInput.value = defaultCoordinates.lon;
		}

		function cancelCoordinatesEdit() {
			const dropdown = document.getElementById('cityDropdown');
			const latInput = document.getElementById('latInput');
			const lonInput = document.getElementById('lonInput');
			const coordinatesForm = document.getElementById('coordinatesForm');
			const defaultCoordsSpan = document.getElementById('defaultCoords');
			const cityTypeLabel = document.getElementById('cityTypeLabel');
			const selectedCity = dropdown.value;
			if (!selectedCity || selectedCity === '') {
				coordinatesForm.classList.add('hide');
				latInput.value = '';
				lonInput.value = '';
				defaultCoordinates.lat = '';
				defaultCoordinates.lon = '';
				defaultCoordsSpan.textContent = '-';
				if (cityTypeLabel) cityTypeLabel.textContent = '';
				return;
			}
			const selectedOption = dropdown.options[dropdown.selectedIndex];
			const defaultLat = selectedOption.getAttribute('data-lat');
			const defaultLon = selectedOption.getAttribute('data-lon');
			fetch('/getcityinfo', {
				method: 'GET',
				headers: {
					'Accept': 'application/json'
				}
			}).then(response => response.json()).then(data => {
				if (data.hasSelection && data.selectedCityApi === selectedCity && data.latitude && data.longitude) {
					latInput.value = data.latitude;
					lonInput.value = data.longitude;
				} else {
					if (defaultLat && defaultLon) {
						latInput.value = defaultLat;
						lonInput.value = defaultLon;
					} else {
						showToast('Tidak ada koordinat tersedia', 'warning');
					}
				}
			}).catch(error => {
				if (defaultLat && defaultLon) {
					latInput.value = defaultLat;
					lonInput.value = defaultLon;
				} else {
					showToast('Tidak ada koordinat tersedia', 'warning');
				}
			});
		}
		async function loadCurrentCity() {
			try {
				const response = await fetch('/getcityinfo', {
					method: 'GET',
					headers: {
						'Accept': 'application/json'
					}
				});
				if (!response.ok) {
					throw new Error('HTTP ' + response.status);
				}
				const data = await response.json();
				const currentCitySpan = document.getElementById('currentCity');
				const dropdown = document.getElementById('cityDropdown');
				const coordinatesForm = document.getElementById('coordinatesForm');
				const latInput = document.getElementById('latInput');
				const lonInput = document.getElementById('lonInput');
				const defaultCoordsSpan = document.getElementById('defaultCoords');
				if (data.hasSelection && data.selectedCityApi) {
					let displayText = data.selectedCity;
					if (data.latitude && data.longitude) {
						displayText += ` (${parseFloat(data.latitude).toFixed(4)}¬∞, ${parseFloat(data.longitude).toFixed(4)}¬∞)`;
					}
					currentCitySpan.textContent = displayText;
					currentCitySpan.className = 'text-primary';
					dropdown.value = data.selectedCityApi;
					const cityTypeLabel = document.getElementById('cityTypeLabel');
					if (cityTypeLabel && dropdown.value) {
						const selectedOption = dropdown.options[dropdown.selectedIndex];
						if (selectedOption) {
							const typeLabel = selectedOption.getAttribute('data-type');
							const typeEmoji = selectedOption.getAttribute('data-type-emoji');
							if (typeLabel && typeEmoji) {
								cityTypeLabel.textContent = `${typeEmoji} ${typeLabel}`;
							} else {
								cityTypeLabel.textContent = '';
							}
						}
					}
					if (data.latitude && data.longitude) {
						const selectedOption = dropdown.options[dropdown.selectedIndex];
						if (selectedOption) {
							const defaultLat = selectedOption.getAttribute('data-lat');
							const defaultLon = selectedOption.getAttribute('data-lon');
							if (defaultLat && defaultLon) {
								defaultCoordinates.lat = defaultLat;
								defaultCoordinates.lon = defaultLon;
								defaultCoordsSpan.textContent = `${parseFloat(defaultLat).toFixed(4)}¬∞, ${parseFloat(defaultLon).toFixed(4)}¬∞`;
							}
						}
						latInput.value = data.latitude;
						lonInput.value = data.longitude;
						coordinatesForm.classList.remove('hide');
					}
				} else {
					currentCitySpan.textContent = 'Pilih lokasi';
					currentCitySpan.className = 'subheader';
					dropdown.selectedIndex = 0;
					if (coordinatesForm) {
						coordinatesForm.classList.add('hide');
					}
				}
			} catch (error) {
				document.getElementById('currentCity').textContent = 'Terjadi kesalahan memuat';
			}
		}
		async function saveCity() {
			const dropdown = document.getElementById('cityDropdown');
			const selectedCity = dropdown.value;
			if (!selectedCity) {
				showToast('Silakan pilih lokasi terlebih dahulu', 'error');
				return;
			}
			const selectedOption = dropdown.options[dropdown.selectedIndex];
			const latInput = document.getElementById('latInput');
			const lonInput = document.getElementById('lonInput');
			const typeLabel = selectedOption.getAttribute('data-type');
			const typeEmoji = selectedOption.getAttribute('data-type-emoji');
			let lat = latInput.value.trim();
			let lon = lonInput.value.trim();
			if (!lat || !lon) {
				showToast('Latitude dan longitude harus diisi', 'error');
				return;
			}
			const latNum = parseFloat(lat);
			const lonNum = parseFloat(lon);
			if (isNaN(latNum) || isNaN(lonNum)) {
				showToast('Format tidak valid. Gunakan angka dengan titik desimal', 'error');
				return;
			}
			if (latNum < -91 || latNum > 91) {
				showToast('Latitude harus antara -90 hingga 90', 'error');
				return;
			}
			if (lonNum < -181 || lonNum > 181) {
				showToast('Longitude harus antara -180 hingga 180', 'error');
				return;
			}
			const cityData = cityList.find(c => c.api === selectedCity);
			const displayName = cityData ? cityData.display : selectedCity;
			const btn = event.target;
			const originalText = btn.textContent;
			btn.disabled = true;
			btn.textContent = 'Menyimpan...';
			try {
				const formData = new URLSearchParams();
				formData.append('city', selectedCity);
				formData.append('cityName', displayName);
				formData.append('lat', lat);
				formData.append('lon', lon);
				if (typeLabel) {
					formData.append('type', typeLabel);
				}
				const controller = new AbortController();
				const timeoutId = setTimeout(() => controller.abort(), 10000);
				const response = await fetch('/setcity', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded',
						'Accept': 'application/json'
					},
					body: formData.toString(),
					signal: controller.signal
				});
				clearTimeout(timeoutId);
				if (response.ok) {
					showToast('Lokasi berhasil disimpan', 'success');
					setTimeout(() => {
						loadCurrentCity();
					}, 1000);
					setTimeout(() => {
						loadSavedPrayerTimes();
					}, 3000);
				} else {
					throw new Error('Gagal menyimpan lokasi');
				}
			} catch (error) {
				showToast('Gagal menyimpan lokasi', 'error');
			} finally {
				btn.disabled = false;
				btn.textContent = originalText;
			}
		}
		// ================================
		// LOAD BUZZER CONFIG
		// ================================
		async function loadBuzzerConfig() {
			try {
				const response = await fetch('/getbuzzerconfig');
				const data = await response.json();

				document.getElementById('toggle-imsak').checked = data.imsak;
				document.getElementById('toggle-subuh').checked = data.subuh;
				document.getElementById('toggle-terbit').checked = data.terbit;
				document.getElementById('toggle-zuhur').checked = data.zuhur;
				document.getElementById('toggle-ashar').checked = data.ashar;
				document.getElementById('toggle-maghrib').checked = data.maghrib;
				document.getElementById('toggle-isya').checked = data.isya;

				const volumeSlider = document.getElementById('volumeSlider');
				const volumeValue = document.getElementById('volumeValue');
				volumeSlider.value = data.volume;
				volumeValue.textContent = data.volume + '%';

			} catch (error) {
			}
		}

		// ================================
		// SAVE BUZZER TOGGLE
		// ================================
		async function saveBuzzerToggle(prayer, enabled) {
			try {
				const formData = new URLSearchParams();
				formData.append('prayer', prayer);
				formData.append('enabled', enabled ? 'true' : 'false');

				await fetch('/setbuzzertoggle', {
					method: 'POST',
					headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
					body: formData.toString()
				});

			} catch (error) {
			}
		}

		// ================================
		// SAVE BUZZER VOLUME
		// ================================
		let volumeSaveTimeout = null;
		async function saveBuzzerVolume(volume) {
			// Debounce - tunggu 500ms setelah user berhenti drag
			clearTimeout(volumeSaveTimeout);

			volumeSaveTimeout = setTimeout(async () => {
				try {
					const formData = new URLSearchParams();
					formData.append('volume', volume);

					const response = await fetch('/setbuzzervolume', {
						method: 'POST',
						headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
						body: formData.toString()
					});

					if (response.ok) {
					}
				} catch (error) {
				}
			}, 500);
		}

		async function toggleTestBuzzer() {
			const btn = document.getElementById('testBuzzerBtn');
			
			if (buzzerTestInterval) {
				// Stop test
				clearInterval(buzzerTestInterval);
				buzzerTestInterval = null;
				
				// Stop buzzer on server
				await fetch('/stopbuzzer', { method: 'POST' });
				
				btn.textContent = 'üîî Test Buzzer';
				btn.classList.remove('alert');
				btn.classList.add('secondary');
				
			} else {
				const volume = document.getElementById('volumeSlider').value;
				
				try {
					const response = await fetch('/testbuzzer', {
						method: 'POST',
						headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
						body: 'volume=' + volume
					});
					
					if (response.ok) {
						btn.textContent = '‚èπ Stop Test';
						btn.classList.remove('secondary');
						btn.classList.add('alert');
						
						showToast('Buzzer test dimulai (akan otomatis berhenti dalam 30 detik)', 'success');
						
						setTimeout(() => {
							if (buzzerTestInterval) {
								toggleTestBuzzer();
							}
						}, 30000);
					}
				} catch (error) {
					showToast('Gagal menguji buzzer', 'error');
				}
			}
		}

		// ================================
		// PRAYER SCHEDULE
		// ================================
		async function loadSavedPrayerTimes() {
			if (isLoadingPrayerTimes) {
				return false;
			}
			isLoadingPrayerTimes = true;
			try {
				const response = await fetch('/getprayertimes');
				const data = await response.json();
				prayerConfig.imsakTime = data.imsak || '00:00';
				prayerConfig.subuhTime = data.subuh || '00:00';
				prayerConfig.terbitTime = data.terbit || '00:00';
				prayerConfig.zuhurTime = data.zuhur || '00:00';
				prayerConfig.asharTime = data.ashar || '00:00';
				prayerConfig.maghribTime = data.maghrib || '00:00';
				prayerConfig.isyaTime = data.isya || '00:00';
				document.getElementById('imsakTime').textContent = prayerConfig.imsakTime;
				document.getElementById('subuhTime').textContent = prayerConfig.subuhTime;
				document.getElementById('terbitTime').textContent = prayerConfig.terbitTime;
				document.getElementById('zuhurTime').textContent = prayerConfig.zuhurTime;
				document.getElementById('asharTime').textContent = prayerConfig.asharTime;
				document.getElementById('maghribTime').textContent = prayerConfig.maghribTime;
				document.getElementById('isyaTime').textContent = prayerConfig.isyaTime;
				return true;
			} catch (error) {
				return false;
			} finally {
				isLoadingPrayerTimes = false;
			}
		}
		// ================================
		// WIFI & AP SETTINGS
		// ================================
		let savedWiFiConfig = {
			routerSSID: '',
			routerPassword: '',
			apSSID: '',
			apPassword: ''
		};
		async function loadWiFiConfig() {
			try {
				const response = await fetch('/getwificonfig', {
					method: 'GET',
					headers: {
						'Accept': 'application/json'
					}
				});
				if (!response.ok) {
					throw new Error('HTTP ' + response.status);
				}
				const data = await response.json();
				savedWiFiConfig.routerSSID = data.routerSSID || '';
				savedWiFiConfig.routerPassword = data.routerPassword || '';
				savedWiFiConfig.apSSID = data.apSSID || '';
				savedWiFiConfig.apPassword = data.apPassword || '';
				const wifiSSIDInput = document.getElementById('wifiSSID');
				const wifiPasswordInput = document.getElementById('wifiPassword');
				if (wifiSSIDInput) {
					wifiSSIDInput.value = savedWiFiConfig.routerSSID;
				}
				if (wifiPasswordInput) {
					wifiPasswordInput.value = savedWiFiConfig.routerPassword;
				}
				const apSSIDInput = document.getElementById('apSSID');
				const apPasswordInput = document.getElementById('apPassword');
				if (apSSIDInput) {
					apSSIDInput.value = savedWiFiConfig.apSSID;
				}
				if (apPasswordInput) {
					apPasswordInput.value = savedWiFiConfig.apPassword;
				}
				const apIPInput = document.getElementById('apIP');
				const gatewayInput = document.getElementById('gatewayIP');
				const subnetInput = document.getElementById('subnetMask');
				if (apIPInput && data.apIP) apIPInput.value = data.apIP;
				if (gatewayInput && data.apGateway) gatewayInput.value = data.apGateway;
				if (subnetInput && data.apSubnet) subnetInput.value = data.apSubnet;
				return true;
			} catch (error) {
				return false;
			}
		}

		function setWiFi() {
			const ssid = document.getElementById('wifiSSID').value.trim();
			const password = document.getElementById('wifiPassword').value;
			if (!ssid) {
				showToast('SSID WiFi tidak boleh kosong', 'error');
				return;
			}
			const btn = event.target;
			const originalText = btn.textContent;
			btn.disabled = true;
			btn.textContent = 'Menyimpan...';
			fetch('/setwifi', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded',
				},
				body: `ssid=${encodeURIComponent(ssid)}&password=${encodeURIComponent(password)}`
			}).then(response => {
				if (response.ok) {
					savedWiFiConfig.routerSSID = ssid;
					if (password) {
						savedWiFiConfig.routerPassword = password;
					}
					showToast('Pengaturan WiFi berhasil disimpan', 'success');
					setTimeout(() => {
						loadWiFiConfig();
					}, 1000);

					btn.disabled = false;
					btn.textContent = originalText;
				} else {
					throw new Error('Penyimpanan gagal');
				}
			}).catch(error => {
				showToast('Gagal menyimpan WiFi', 'error');
				btn.disabled = false;
				btn.textContent = originalText;
			});
		}

		function clearWiFiForm() {
			loadWiFiConfig();
		}

		// ================================
		// WIFI & AP SETTINGS
		// ================================
		function setAP() {
			if (event && event.target) {
				const buttonText = event.target.textContent.trim();

				if (buttonText !== 'Simpan') {
					return;
				}

				const isAPCredButton = event.target.closest('.grid-x')?.querySelector('#apSSID') !== null;
				if (!isAPCredButton) {
					return;
				}
			}

			const ssid = document.getElementById('apSSID').value.trim();
			const pass = document.getElementById('apPassword').value;

			if (!ssid) {
				showToast('SSID Access Point tidak boleh kosong', 'error');
				return;
			}

			if (pass.length > 0 && pass.length < 8) {
				showToast('Password minimal 8 karakter', 'error');
				return;
			}

			const btn = event.target;
			const originalText = btn.textContent;
			btn.disabled = true;
			btn.textContent = 'Menyimpan...';

			const formData = new URLSearchParams();
			formData.append('ssid', ssid);
			formData.append('password', pass);
			formData.append('updateNetworkConfig', 'false');

			fetch('/setap', {
				method: 'POST',
				headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
				body: formData.toString()
			})
				.then(response => {
					if (response.ok) {
						savedWiFiConfig.apSSID = ssid;
						if (pass) savedWiFiConfig.apPassword = pass;

						showToast(`Pengaturan Access Point "${ssid}" berhasil disimpan`, 'success');

						setTimeout(() => loadWiFiConfig(), 1000);

						btn.disabled = false;
						btn.textContent = originalText;

						startCountdownPolling();
					} else {
						return response.text().then(text => { throw new Error(text); });
					}
				})
				.catch(error => {
					showToast('Gagal menyimpan Access Point: ' + error.message, 'error');
					btn.disabled = false;
					btn.textContent = originalText;
				});
		}

		function setAPNetwork() {
			if (event && event.target) {
				const buttonText = event.target.textContent.trim();

				if (buttonText !== 'Simpan') {
					return;
				}

				const isNetworkConfigButton = event.target.closest('.grid-x')?.querySelector('#apIP') !== null;
				if (!isNetworkConfigButton) {
					return;
				}
			}

			const apIP = document.getElementById('apIP').value.trim();
			const gateway = document.getElementById('gatewayIP').value.trim();
			const subnet = document.getElementById('subnetMask').value.trim();

			if (!apIP && !gateway && !subnet) {
				showToast('Isi minimal satu field konfigurasi jaringan', 'error');
				return;
			}

			const btn = event.target;
			const originalText = btn.textContent;
			btn.disabled = true;
			btn.textContent = 'Menyimpan...';

			const formData = new URLSearchParams();

			formData.append('updateNetworkConfig', 'true');

			if (apIP) formData.append('apIP', apIP);
			if (gateway) formData.append('gateway', gateway);
			if (subnet) formData.append('subnet', subnet);

			fetch('/setap', {
				method: 'POST',
				headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
				body: formData.toString()
			})
				.then(response => {
					if (response.ok) {
						const networkMsg = apIP ? apIP : '192.168.4.1';
						showToast(`Konfigurasi jaringan berhasil disimpan (IP: ${networkMsg})`, 'success');

						setTimeout(() => loadWiFiConfig(), 1000);

						btn.disabled = false;
						btn.textContent = originalText;

						startCountdownPolling();
					} else {
						return response.text().then(text => { throw new Error(text); });
					}
				})
				.catch(error => {
					showToast('Gagal menyimpan konfigurasi: ' + error.message, 'error');
					btn.disabled = false;
					btn.textContent = originalText;
				});
		}

		function clearAPForm() {
			loadWiFiConfig();
		}

		function clearDHCPForm() {
			loadWiFiConfig();
		}

		// ================================
		// UPDATE TIME
		// ================================
		function syncTime() {
			const d = new Date();

			const year = d.getFullYear();
			const month = d.getMonth() + 1;
			const day = d.getDate();
			const hour = d.getHours();
			const minute = d.getMinutes();
			const second = d.getSeconds();

			const btn = event.target;
			btn.disabled = true;
			btn.textContent = 'Perbarui...';

			fetch('/synctime', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded',
				},
				body: `y=${year}&m=${month}&d=${day}&h=${hour}&i=${minute}&s=${second}`
			})
				.then(response => response.text())
				.then(data => {
					showToast('Waktu berhasil diperbarui', 'success');
					updateDeviceStatus();
					btn.disabled = false;
					btn.textContent = 'Perbarui Waktu';
				})
				.catch(error => {
					showToast('Gagal memperbarui waktu', 'error');
					btn.disabled = false;
					btn.textContent = ' Perbarui Waktu';
				});
		}

		// ================================
		// RESET PABRIK
		// ================================
		function resetSettings() {
			if (!confirm('Yakin ingin mereset seluruh pengaturan ke setelan ulang? Perangkat akan memulai ulang dan kembali ke pengaturan ulang.')) {
				return;
			}

			const btn = event.target;
			const originalText = btn.textContent;
			btn.disabled = true;
			btn.textContent = 'Mengatur ulang...';

			fetch('/reset', { method: 'POST' })
				.then(response => {
					if (response.ok) {
						showToast('Pengaturan berhasil diatur ulang', 'success');

						btn.disabled = false;
						btn.textContent = originalText;

						startCountdownPolling();
					} else {
						throw new Error('Pengaturan ulang gagal');
					}
				})
				.catch(error => {
					showToast('Gagal mengatur ulang perangkat', 'error');
					btn.disabled = false;
					btn.textContent = originalText;
				});
		}

		// ================================
		// CITIES.JSON UPLOAD FUNCTION
		// ================================
		let selectedCitiesFile = null;

		function calculateArduinoJsonSize(json) {
			let totalSize = 0;
			totalSize += 24;

			if (Array.isArray(json)) {
				totalSize += 16;
				totalSize += json.length * 8;

				json.forEach(item => {
					if (typeof item === 'object' && item !== null) {
						totalSize += 16;

						const keys = Object.keys(item);
						totalSize += keys.length * 24;

						keys.forEach(key => {
							totalSize += key.length + 1;
							totalSize += Math.ceil((key.length + 1) / 4) * 4;

							const value = item[key];
							if (typeof value === 'string') {
								totalSize += value.length + 1;
								totalSize += Math.ceil((value.length + 1) / 4) * 4;
							} else if (typeof value === 'number') {
								totalSize += 8;
							} else if (typeof value === 'boolean') {
								totalSize += 1;
							}
						});
					}
				});
			}

			totalSize = Math.ceil(totalSize * 1.2);
			return totalSize;
		}

		function handleCitiesFileSelect(event) {
			const file = event.target.files[0];
			const fileNameDisplay = document.getElementById('selectedFileName');
			const uploadBtn = document.getElementById('uploadBtn');
			const clearBtn = document.getElementById('clearFileBtn');

			if (!file) {
				selectedCitiesFile = null;
				fileNameDisplay.textContent = 'Belum ada berkas dipilih';
				fileNameDisplay.className = 'help-text';
				uploadBtn.disabled = true;
				clearBtn.style.display = 'none';
				return;
			}

			if (file.name !== 'cities.json') {
				showToast('Nama berkas harus cities.json', 'error');
				selectedCitiesFile = null;
				fileNameDisplay.innerHTML = '<span class="label alert">‚ùå Nama berkas tidak valid</span>';
				uploadBtn.disabled = true;
				clearBtn.style.display = 'none';
				event.target.value = '';
				return;
			}

			const maxSize = 1 * 1024 * 1024;
			if (file.size > maxSize) {
				showToast('Berkas terlalu besar (maksimal 1MB)', 'error');
				selectedCitiesFile = null;
				fileNameDisplay.innerHTML = '<span class="label alert">‚ùå Berkas terlalu besar</span>';
				uploadBtn.disabled = true;
				clearBtn.style.display = 'none';
				event.target.value = '';
				return;
			}

			const reader = new FileReader();
			reader.onload = function (e) {
				try {
					const json = JSON.parse(e.target.result);

					if (!Array.isArray(json)) {
						throw new Error('JSON harus berupa array');
					}

					if (json.length === 0) {
						throw new Error('Array JSON tidak boleh kosong');
					}

					const requiredFields = ['api', 'display', 'province'];

					for (let i = 0; i < json.length; i++) {
						const item = json[i];

						for (const field of requiredFields) {
							if (!item.hasOwnProperty(field) || !item[field]) {
								throw new Error(`Item ${i}: kolom '${field}' tidak ada atau kosong`);
							}

							if (typeof item[field] !== 'string') {
								throw new Error(`Item ${i}: kolom '${field}' harus berupa teks`);
							}
						}

						if (item.lat) {
							const lat = parseFloat(item.lat);
							if (isNaN(lat) || lat < -90 || lat > 90) {
								throw new Error(`Item ${i}: lintang tidak valid (${item.lat})`);
							}
						}

						if (item.lon) {
							const lon = parseFloat(item.lon);
							if (isNaN(lon) || lon < -180 || lon > 180) {
								throw new Error(`Item ${i}: bujur tidak valid (${item.lon})`);
							}
						}
					}

					const jsonSize = calculateArduinoJsonSize(json);
					const ESP32_MAX_HEAP = 320000;

					if (jsonSize > ESP32_MAX_HEAP) {
						const sizeKB = (jsonSize / 1024).toFixed(2);
						const maxKB = (ESP32_MAX_HEAP / 1024).toFixed(2);

						showToast(`Berkas terlalu berat untuk perangkat ${sizeKB} KB > ${maxKB} KB`, 'error');

						selectedCitiesFile = null;
						fileNameDisplay.innerHTML = `<span class="label alert">‚ùå Terlalu berat (${sizeKB} KB)</span>`;
						uploadBtn.disabled = true;
						clearBtn.style.display = 'none';
						event.target.value = '';
						return;
					}

					selectedCitiesFile = file;
					selectedCitiesFile.jsonMetadata = {
						citiesCount: json.length,
						jsonSize: jsonSize,
						fileSize: file.size
					};

					const sizeKB = (file.size / 1024).toFixed(2);
					const jsonSizeKB = (jsonSize / 1024).toFixed(2);

					fileNameDisplay.innerHTML =
						`<span class="label success">${file.name} (${sizeKB} KB)</span><br>` +
						`<small>${json.length} lokasi | DynamicJsonDocument: ${jsonSizeKB} KB</small>`;
					uploadBtn.disabled = false;
					clearBtn.style.display = 'block';

				} catch (error) {
					showToast('Validasi gagal: ' + error.message, 'error');
					selectedCitiesFile = null;
					fileNameDisplay.innerHTML = `<span class="label alert">‚ùå ${error.message}</span>`;
					uploadBtn.disabled = true;
					clearBtn.style.display = 'none';
					event.target.value = '';
				}
			};

			reader.onerror = function () {
				showToast('Gagal membaca berkas', 'error');
				selectedCitiesFile = null;
				fileNameDisplay.innerHTML = '<span class="label alert">‚ùå Gagal membaca berkas</span>';
				uploadBtn.disabled = true;
				clearBtn.style.display = 'none';
				event.target.value = '';
			};

			reader.readAsText(file);
		}

		async function uploadCitiesFile() {
			if (!selectedCitiesFile) {
				showToast('Pilih berkas terlebih dahulu', 'error');
				return;
			}

			const uploadBtn = document.getElementById('uploadBtn');
			const progressDiv = document.getElementById('uploadProgress');
			const progressBar = document.getElementById('uploadProgressBar');
			const statusText = document.getElementById('uploadStatus');

			uploadBtn.disabled = true;
			uploadBtn.textContent = 'Mengunggah...';
			progressDiv.classList.remove('hide');
			progressBar.style.width = '0%';
			progressBar.querySelector('.progress-meter-text').textContent = '0%';
			statusText.textContent = 'Mulai mengunggah...';

			try {
				const formData = new FormData();
				formData.append('file', selectedCitiesFile);

				if (selectedCitiesFile.jsonMetadata) {
					formData.append('jsonSize', selectedCitiesFile.jsonMetadata.jsonSize);
					formData.append('citiesCount', selectedCitiesFile.jsonMetadata.citiesCount);
				}

				const xhr = new XMLHttpRequest();

				xhr.upload.addEventListener('progress', (e) => {
					if (e.lengthComputable) {
						const percentComplete = Math.round((e.loaded / e.total) * 100);
						progressBar.style.width = percentComplete + '%';
						progressBar.querySelector('.progress-meter-text').textContent = percentComplete + '%';
						statusText.textContent = `Mengunggah: ${(e.loaded / 1024).toFixed(1)} KB / ${(e.total / 1024).toFixed(1)} KB`;
					}
				});

				xhr.addEventListener('load', async () => {
					if (xhr.status === 200) {
						progressBar.style.width = '100%';
						progressBar.querySelector('.progress-meter-text').textContent = '100%';
						statusText.innerHTML = '<span class="label success">Pengunggahan berhasil</span>';

						if (selectedCitiesFile.jsonMetadata) {
							const jsonSizeKB = (selectedCitiesFile.jsonMetadata.jsonSize / 1024).toFixed(2);
							showToast(`cities.json berhasil diunggah ${selectedCitiesFile.jsonMetadata.citiesCount} lokasi`, 'success');
						} else {
							showToast('cities.json berhasil diunggah', 'success');
						}

						document.getElementById('citiesFileInput').value = '';
						document.getElementById('selectedFileName').textContent = 'Belum ada berkas dipilih';
						selectedCitiesFile = null;

						setTimeout(() => {
							showToast('Memperbarui daftar lokasi...', 'warning');
							loadAttempts = 0;
							loadCities();
						}, 2000);

						setTimeout(() => {
							progressDiv.classList.add('hide');
							uploadBtn.disabled = false;
							uploadBtn.textContent = 'Unggah Berkas';
						}, 5000);

					} else {
						throw new Error('Mengunggah gagal');
					}
				});

				xhr.addEventListener('error', () => {
					throw new Error('Terjadi kesalahan jaringan - koneksi terputus');
				});

				xhr.addEventListener('timeout', () => {
					throw new Error('Waktu Mengunggah habis - berkas terlalu lama');
				});

				xhr.open('POST', '/uploadcities', true);
				xhr.timeout = 30000;
				xhr.send(formData);

			} catch (error) {
				progressBar.classList.add('alert');
				progressBar.style.width = '100%';
				statusText.innerHTML = `<span class="label alert">‚ùå ${error.message}</span>`;

				showToast('Mengunggah gagal: ' + error.message, 'error');

				setTimeout(() => {
					progressDiv.classList.add('hide');
					uploadBtn.disabled = false;
					uploadBtn.textContent = 'üì§ Mengunggah Berkas';
				}, 3000);
			}
		}

		function clearSelectedFile() {
			const fileInput = document.getElementById('citiesFileInput');
			const fileNameDisplay = document.getElementById('selectedFileName');
			const uploadBtn = document.getElementById('uploadBtn');
			const clearBtn = document.getElementById('clearFileBtn');

			fileInput.value = '';
			selectedCitiesFile = null;

			fileNameDisplay.textContent = 'Belum ada berkas yang dipilih';
			fileNameDisplay.className = 'help-text';

			uploadBtn.disabled = true;
			clearBtn.style.display = 'none';

			showToast('Berkas dihapus', 'warning');
		}

		// ================================
		// METHOD SELECTION FUNCTION
		// ================================
		async function loadCurrentMethod() {
			if (isLoadingMethod) {
				return false;
			}

			isLoadingMethod = true;

			try {
				const response = await fetch('/getmethod', {
					method: 'GET',
					headers: {
						'Accept': 'application/json'
					}
				});

				if (!response.ok) {
					throw new Error('HTTP ' + response.status);
				}

				const data = await response.json();

				if (data.methodId !== undefined) {
					methodConfig.methodId = data.methodId;
					methodConfig.methodName = data.methodName;
				} else {
					methodConfig.methodId = 5;
					methodConfig.methodName = 'Egyptian General Authority of Survey';
				}

				const currentMethodTop = document.getElementById('currentMethodTop');
				const currentMethodBottom = document.getElementById('currentMethodBottom');
				const methodDropdown = document.getElementById('methodDropdown');

				if (currentMethodTop) {
					currentMethodTop.textContent = methodConfig.methodName;
				}
				if (currentMethodBottom) {
					currentMethodBottom.textContent = methodConfig.methodName;
				}
				if (methodDropdown) {
					methodDropdown.value = methodConfig.methodId;
				}

				return true;

			} catch (error) {
				methodConfig.methodId = 5;
				methodConfig.methodName = 'Egyptian General Authority of Survey';

				const currentMethodTop = document.getElementById('currentMethodTop');
				const currentMethodBottom = document.getElementById('currentMethodBottom');
				if (currentMethodTop) currentMethodTop.textContent = methodConfig.methodName;
				if (currentMethodBottom) currentMethodBottom.textContent = methodConfig.methodName;

				return false;
			} finally {
				isLoadingMethod = false;
			}
		}

		async function saveMethod() {
			const dropdown = document.getElementById('methodDropdown');
			const methodId = dropdown.value;
			const methodName = dropdown.options[dropdown.selectedIndex].text;

			if (!methodId) {
				showToast('Silakan pilih metode terlebih dahulu', 'error');
				return;
			}

			const btn = event.target;
			const originalText = btn.textContent;
			btn.disabled = true;
			btn.textContent = 'Menyimpan...';

			try {
				const formData = new URLSearchParams();
				formData.append('methodId', methodId);
				formData.append('methodName', methodName);

				const controller = new AbortController();
				const timeoutId = setTimeout(() => controller.abort(), 10000);

				const response = await fetch('/setmethod', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded',
						'Accept': 'application/json'
					},
					body: formData.toString(),
					signal: controller.signal
				});

				clearTimeout(timeoutId);

				if (response.ok) {
					const result = await response.json();

					showToast('Metode kalkulasi berhasil disimpan', 'success');

					const currentMethodTop = document.getElementById('currentMethodTop');
					const currentMethodBottom = document.getElementById('currentMethodBottom');

					if (currentMethodTop) {
						currentMethodTop.textContent = methodName;
					}
					if (currentMethodBottom) {
						currentMethodBottom.textContent = methodName;
					}

					if (result.prayerTimesUpdating) {
						setTimeout(() => {
							showToast('Jadwal salat sedang diperbarui dengan metode baru...', 'warning');
						}, 1500);

						setTimeout(() => {
							loadSavedPrayerTimes();
						}, 4000);
					} else {
						setTimeout(() => {
							showToast('Metode disimpan. Pilih lokasi untuk menghitung jadwal salat jika belum diatur', 'warning');
						}, 1500);
					}

				} else {
					throw new Error('Gagal menyimpan metode');
				}

			} catch (error) {
				showToast('Gagal menyimpan metode', 'error');

			} finally {
				btn.disabled = false;
				btn.textContent = originalText;
			}
		}

		async function restartDevice() {
			if (!confirm('üîÑ Yakin ingin mulai ulang perangkat?')) {
				return;
			}

			const btn = event.target;
			const originalText = btn.textContent;
			btn.disabled = true;
			btn.textContent = 'Mulsi ulang...';

			try {
				const response = await fetch('/restart', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded'
					}
				});

				if (response.ok) {
					showToast('Perangkat sedang memulai ulang', 'success');

					btn.disabled = false;
					btn.textContent = originalText;

					startCountdownPolling();
				} else {
					throw new Error('Mulai ulang gagal');
				}
			} catch (error) {
				showToast('Gagal mulai ulang perangkat', 'error');
				btn.disabled = false;
				btn.textContent = originalText;
			}
		}

		// ================================
		// TIMEZONE FUNCTION - INLINE EDITING
		// ================================
		let isEditingTimezone = false;

		function toggleTimezoneEdit() {
			const displayText = document.getElementById('timezoneDisplayText');
			const input = document.getElementById('timezoneInput');
			const btn = document.getElementById('timezoneBtn');
			const cancelBtn = document.getElementById('timezoneCancelBtn');

			if (!isEditingTimezone) {
				displayText.style.display = 'none';
				input.style.display = 'inline-block';
				input.value = timezoneConfig.offset >= 0 ? '+' + timezoneConfig.offset : timezoneConfig.offset;
				input.focus();
				input.select();
				btn.textContent = 'üíæ';
				btn.title = 'Simpan Zona Waktu';
				cancelBtn.style.display = 'inline-block';
				isEditingTimezone = true;
			} else {
				saveTimezone();
			}
		}

		function cancelTimezoneEdit() {
			const displayText = document.getElementById('timezoneDisplayText');
			const input = document.getElementById('timezoneInput');
			const btn = document.getElementById('timezoneBtn');
			const cancelBtn = document.getElementById('timezoneCancelBtn');

			displayText.style.display = 'inline';
			input.style.display = 'none';
			btn.textContent = 'üïê';
			btn.title = 'Edit Zona Waktu';
			cancelBtn.style.display = 'none';
			isEditingTimezone = false;

			input.value = timezoneConfig.offset >= 0 ? '+' + timezoneConfig.offset : timezoneConfig.offset;
		}

		async function loadTimezoneConfig() {
			try {
				const response = await fetch('/gettimezone', {
					method: 'GET',
					headers: {
						'Accept': 'application/json'
					}
				});

				if (!response.ok) {
					throw new Error('HTTP ' + response.status);
				}

				const data = await response.json();

				if (data.offset !== undefined) {
					timezoneConfig.offset = data.offset;
				} else {
					timezoneConfig.offset = 7;
				}

				updateTimezoneDisplay();

				return true;

			} catch (error) {
				timezoneConfig.offset = 7;
				updateTimezoneDisplay();
				return false;
			}
		}

		function updateTimezoneDisplay() {
			const displayText = document.getElementById('timezoneDisplayText');
			const input = document.getElementById('timezoneInput');

			const displayValue = (timezoneConfig.offset >= 0 ? '+' : '') + timezoneConfig.offset;

			if (displayText) {
				displayText.textContent = displayValue;
			}
			if (input) {
				input.value = displayValue;
			}
		}

		async function saveTimezone() {
			const input = document.getElementById('timezoneInput');
			const displayText = document.getElementById('timezoneDisplayText');
			const btn = document.getElementById('timezoneBtn');
			const cancelBtn = document.getElementById('timezoneCancelBtn');

			let offsetStr = input.value.trim();

			if (!offsetStr) {
				showToast('Zona Waktu offset tidak boleh kosong', 'error');
				input.focus();
				return;
			}

			let offset = parseInt(offsetStr);

			if (isNaN(offset)) {
				showToast('Format tidak valid. Contoh: +7, -5, +8', 'error');
				input.focus();
				return;
			}

			if (offset < -12 || offset > 14) {
				showToast('Offset harus antara -12 hingga +14', 'error');
				input.focus();
				return;
			}

			btn.disabled = true;
			btn.textContent = '...';

			try {
				const formData = new URLSearchParams();
				formData.append('offset', offset);

				const controller = new AbortController();
				const timeoutId = setTimeout(() => controller.abort(), 10000);

				const response = await fetch('/settimezone', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded',
						'Accept': 'application/json'
					},
					body: formData.toString(),
					signal: controller.signal
				});

				clearTimeout(timeoutId);

				if (response.ok) {
					const result = await response.json();

					timezoneConfig.offset = offset;

					const displayValue = (offset >= 0 ? '+' : '') + offset;
					displayText.textContent = displayValue;
					input.value = displayValue;

					displayText.style.display = 'inline';
					input.style.display = 'none';
					btn.textContent = 'üïê';
					btn.title = 'Edit Zona Waktu';
					btn.disabled = false;
					isEditingTimezone = false;
					cancelBtn.style.display = 'none';

					showToast('Zona waktu berhasil disimpan', 'success');

					setTimeout(() => {
						showToast('NTP akan melakukan perbarui ulang dengan zona waktu baru...', 'warning');
					}, 1500);

				} else {
					throw new Error('Gagal menyimpan zona waktu');
				}

			} catch (error) {
				showToast('Gagal menyimpan zona waktu', 'error');

				btn.textContent = 'üíæ';
				btn.disabled = false;
				input.focus();
			}
		}

		// ================================
		// VANILLA JS TABS FUNCTIONALITY
		// ================================
		function initTabs() {
			const tabLinks = document.querySelectorAll('.tabs a');
			const tabPanels = document.querySelectorAll('.tabs-panel');

			tabLinks.forEach(link => {
				link.addEventListener('click', function (e) {
					e.preventDefault();
					const targetId = this.getAttribute('href').substring(1);

					document.querySelectorAll('.tabs-title').forEach(tab => {
						tab.classList.remove('is-active');
					});
					tabPanels.forEach(panel => {
						panel.classList.remove('is-active');
					});

					this.parentElement.classList.add('is-active');
					document.getElementById(targetId).classList.add('is-active');

					// Load tab data
					handleTabClick(targetId);
				});
			});
		}

		// ================================
		// INITIALIZATION
		// ================================
		async function initializeApp() {
			const progressBar = document.getElementById('loadingProgress');
			const percentage = document.getElementById('loadingPercentage');
			const status = document.getElementById('loadingStatus');

			let currentProgress = 0;

			function updateProgress(targetProgress, message) {
				return new Promise((resolve) => {
					const interval = setInterval(() => {
						if (currentProgress < targetProgress) {
							currentProgress += 1;
							if (progressBar) progressBar.style.width = currentProgress + '%';
							if (percentage) percentage.textContent = currentProgress + '%';
							if (status) status.textContent = message;
						} else {
							clearInterval(interval);
							resolve();
						}
					}, 20);
				});
			}

			const LOADING_TIMEOUT = 10000;
			let timeoutReached = false;

			const timeoutTimer = setTimeout(() => {
				timeoutReached = true;
				if (status) status.textContent = 'Timeout - melanjutkan...';
				setTimeout(() => {
					LoadingManager.completeLoading();
				}, 500);
			}, LOADING_TIMEOUT);

			try {
				if (status) status.textContent = 'Memuat halaman...';
				await updateProgress(10, 'Memuat halaman...');

				await cssLoaded;
				await updateProgress(50, 'Menyiapkan tampilan...');

				if (status) status.textContent = 'Mengecek status server...';
				await updateProgress(60, 'Mengecek status server...');

				try {
					const countdownCheck = await fetch('/api/countdown');
					const countdownData = await countdownCheck.json();

					if (countdownData.active && countdownData.remaining > 0) {

						await updateProgress(100, countdownData.message + '...');

						LoadingManager.completeLoading();

						// Start countdown dengan data dari server
						const clientNow = Date.now();
						countdownEndTime = clientNow + (countdownData.remaining * 1000);
						countdownReason = countdownData.reason;
						countdownMessage = countdownData.message;
						countdownTotalSeconds = countdownData.total || countdownData.remaining;

						startCountdownDisplay(countdownData);
						startLocalCountdownTicker();
						startCountdownPolling();

						return;
					}
				} catch (err) {
				}

				await updateProgress(90, 'Menyiapkan halaman...');
				initTabs();

				setInterval(updateRealtimeDisplay, 1000);

				setInterval(() => {
					const activePanel = document.querySelector('.tabs-panel.is-active');
					const activeTab = activePanel ? activePanel.getAttribute('id') : null;

					if (activeTab === 'home') {
						updateDeviceStatus();
					} else if (activeTab === 'prayer') {
						loadSavedPrayerTimes();
					}
				}, 5000);

				await updateProgress(100, 'Siap digunakan');
				await new Promise(r => setTimeout(r, 300));

				clearTimeout(timeoutTimer);

				LoadingManager.completeLoading();

			} catch (error) {
				clearTimeout(timeoutTimer);

				if (status) status.textContent = 'Error: ' + error.message;
				await updateProgress(100, 'Selesai dengan error');

				setTimeout(() => {
					LoadingManager.completeLoading();
				}, 1500);
			}
		}

		document.addEventListener('DOMContentLoaded', function () {
			document.body.classList.add('loading');

			setTimeout(() => {
				forceRemoveLoadingState();
			}, 15000);

			LoadingManager.updateProgress(1, 'Action');

			initializeApp();

			setTimeout(() => {
				handleTabClick('home');
			}, 500);

			const wifiCredInputs = document.querySelectorAll('input[data-form="wifi-credentials"]');
			const apCredInputs = document.querySelectorAll('input[data-form="ap-credentials"]');
			const networkConfigInputs = document.querySelectorAll('input[data-form="network-config"]');

			wifiCredInputs.forEach(input => {
				input.addEventListener('change', function (e) {
					e.stopPropagation();
				});
			});

			apCredInputs.forEach(input => {
				input.addEventListener('change', function (e) {
					e.stopPropagation();
				});
			});

			networkConfigInputs.forEach(input => {
				input.addEventListener('change', function (e) {
					e.stopPropagation();
				});
			});

			document.querySelectorAll('.buzzer-toggle').forEach(toggle => {
				toggle.addEventListener('change', function () {
					const prayer = this.getAttribute('data-prayer');
					const enabled = this.checked;
					saveBuzzerToggle(prayer, enabled);
				});
			});

			const volumeSlider = document.getElementById('volumeSlider');
			const volumeValue = document.getElementById('volumeValue');

			volumeSlider.addEventListener('input', function () {
				volumeValue.textContent = this.value + '%';
				this.style.setProperty('--slider-value', this.value + '%');
			});

			volumeSlider.addEventListener('change', function () {
				saveBuzzerVolume(this.value);
			});

			// ================================
			// ESC KEY HANDLER
			// ================================
			document.addEventListener('keydown', function (e) {
				if (e.key === 'Escape') {
					if (isEditingTimezone) {
						cancelTimezoneEdit();
					}

					const clearBtn = document.getElementById('clearFileBtn');
					if (clearBtn && clearBtn.style.display === 'block') {
						clearSelectedFile();
					}
				}
			});

			// ================================
			// VALIDATE IP ADDRESS INPUT
			// ================================
			const apIPInput = document.getElementById('apIP');
			const gatewayInput = document.getElementById('gatewayIP');
			const subnetInput = document.getElementById('subnetMask');

			function validateIPAddress(ip) {
				const ipPattern = /^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/;
				const match = ip.match(ipPattern);

				if (!match) return false;

				for (let i = 1; i <= 4; i++) {
					const octet = parseInt(match[i]);
					if (octet < 0 || octet > 255) return false;
				}

				return true;
			}

			function setupIPInput(input, fieldName) {
				if (!input) return;

				// Validasi karakter yang diketik
				input.addEventListener('keydown', function (e) {
					// Izinkan keyboard shortcuts dan navigation keys
					if ([8, 9, 27, 13, 37, 38, 39, 40, 46].indexOf(e.keyCode) !== -1 ||
						(e.keyCode === 65 && e.ctrlKey === true) ||
						(e.keyCode === 67 && e.ctrlKey === true) ||
						(e.keyCode === 86 && e.ctrlKey === true) ||
						(e.keyCode === 88 && e.ctrlKey === true) ||
						(e.keyCode === 65 && e.metaKey === true) ||
						(e.keyCode === 67 && e.metaKey === true) ||
						(e.keyCode === 86 && e.metaKey === true) ||
						(e.keyCode === 88 && e.metaKey === true)) {
						return;
					}

					const char = e.key;
					// Hanya izinkan angka dan titik
					if (!/^[\d\.]$/.test(char)) {
						e.preventDefault();
					}
				});

				input.addEventListener('blur', function () {
					const value = this.value.trim();

					if (value === '') {
						this.style.borderColor = '';
						return;
					}

					if (!validateIPAddress(value)) {
						showToast(`${fieldName} tidak valid. Format: xxx.xxx.xxx.xxx (0-255)`, 'warning');
						this.style.borderColor = '#cc4b37';
					} else {
						this.style.borderColor = '#3adb76';
					}
				});

				input.addEventListener('input', function () {
					const value = this.value;

					if (/[^\d\.]/.test(value)) {
						this.value = value.replace(/[^\d\.]/g, '');
					}

					if (/\.{2,}/.test(value)) {
						this.value = value.replace(/\.{2,}/g, '.');
					}

					const dots = (value.match(/\./g) || []).length;
					if (dots > 3) {
						const parts = value.split('.');
						this.value = parts.slice(0, 4).join('.');
					}

					const parts = value.split('.');
					const validParts = parts.map(part => {
						if (part.length > 3) {
							return part.substring(0, 3);
						}
						return part;
					});

					if (validParts.join('.') !== value) {
						this.value = validParts.join('.');
					}
				});
			}

			setupIPInput(apIPInput, 'IP Address Access Point');
			setupIPInput(gatewayInput, 'Gateway');
			setupIPInput(subnetInput, 'Subnet Mask');

			// ================================
			// TIMEZONE INPUT - ENTER KEY TO SAVE
			// ================================
			const timezoneInput = document.getElementById('timezoneInput');
			if (timezoneInput) {
				timezoneInput.addEventListener('keydown', function (e) {
					if (e.key === 'Enter' && isEditingTimezone) {
						e.preventDefault();
						saveTimezone();
					}

					if (e.key === 'Escape' && isEditingTimezone) {
						e.preventDefault();
						cancelTimezoneEdit();
					}

					// Validasi ketik hanya + - dan angka, tapi izinkan keyboard shortcuts
					if ([8, 9, 27, 13, 37, 38, 39, 40, 46].indexOf(e.keyCode) !== -1 ||
						(e.keyCode === 65 && e.ctrlKey === true) ||
						(e.keyCode === 67 && e.ctrlKey === true) ||
						(e.keyCode === 86 && e.ctrlKey === true) ||
						(e.keyCode === 88 && e.ctrlKey === true) ||
						(e.keyCode === 65 && e.metaKey === true) ||
						(e.keyCode === 67 && e.metaKey === true) ||
						(e.keyCode === 86 && e.metaKey === true) ||
						(e.keyCode === 88 && e.metaKey === true)) {
						return;
					}

					const char = e.key;
					if (!/^[\d\+\-]$/.test(char)) {
						e.preventDefault();
					}
				});
			}

			// ================================
			// INPUT COORDINATES - FREE TYPING and PASTE
			// ================================
			const latInput = document.getElementById('latInput');
			if (latInput) {
				latInput.addEventListener('keydown', function (e) {
					// Izinkan keyboard shortcuts dan navigation keys
					if ([8, 9, 27, 13, 37, 38, 39, 40, 46].indexOf(e.keyCode) !== -1 ||
						(e.keyCode === 65 && e.ctrlKey === true) ||
						(e.keyCode === 67 && e.ctrlKey === true) ||
						(e.keyCode === 86 && e.ctrlKey === true) ||
						(e.keyCode === 88 && e.ctrlKey === true) ||
						(e.keyCode === 65 && e.metaKey === true) ||
						(e.keyCode === 67 && e.metaKey === true) ||
						(e.keyCode === 86 && e.metaKey === true) ||
						(e.keyCode === 88 && e.metaKey === true)) {
						return;
					}

					const char = e.key;
					if (!/^[\d\.\+\-]$/.test(char)) {
						e.preventDefault();
					}
				});

				latInput.addEventListener('blur', function () {
					const val = parseFloat(this.value);
					if (!isNaN(val) && (val < -90 || val > 90)) {
						showToast('Latitude harus antara -90 hingga 90', 'warning');
						this.style.borderColor = '#cc4b37';
					} else {
						this.style.borderColor = '';
					}
				});
			}

			const lonInput = document.getElementById('lonInput');
			if (lonInput) {
				lonInput.addEventListener('keydown', function (e) {
					if ([8, 9, 27, 13, 37, 38, 39, 40, 46].indexOf(e.keyCode) !== -1 ||
						(e.keyCode === 65 && e.ctrlKey === true) ||
						(e.keyCode === 67 && e.ctrlKey === true) ||
						(e.keyCode === 86 && e.ctrlKey === true) ||
						(e.keyCode === 88 && e.ctrlKey === true) ||
						(e.keyCode === 65 && e.metaKey === true) ||
						(e.keyCode === 67 && e.metaKey === true) ||
						(e.keyCode === 86 && e.metaKey === true) ||
						(e.keyCode === 88 && e.metaKey === true)) {
						return;
					}

					const char = e.key;
					if (!/^[\d\.\+\-]$/.test(char)) {
						e.preventDefault();
					}
				});

				lonInput.addEventListener('blur', function () {
					const val = parseFloat(this.value);
					if (!isNaN(val) && (val < -180 || val > 180)) {
						showToast('Longitude harus antara -180 hingga 180', 'warning');
						this.style.borderColor = '#cc4b37';
					} else {
						this.style.borderColor = '';
					}
				});
			}

			// ================================
			// FILE INPUT - DRAG & DROP SUPPORT
			// ================================
			const citiesFileInput = document.getElementById('citiesFileInput');
			const fileLabel = citiesFileInput ? citiesFileInput.closest('label') : null;

			if (fileLabel) {
				['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
					fileLabel.addEventListener(eventName, preventDefaults, false);
					document.body.addEventListener(eventName, preventDefaults, false);
				});

				function preventDefaults(e) {
					e.preventDefault();
					e.stopPropagation();
				}

				['dragenter', 'dragover'].forEach(eventName => {
					fileLabel.addEventListener(eventName, function () {
						this.style.borderColor = '#1779ba';
						this.style.backgroundColor = '#e7f4ff';
					}, false);
				});

				['dragleave', 'drop'].forEach(eventName => {
					fileLabel.addEventListener(eventName, function () {
						this.style.borderColor = '';
						this.style.backgroundColor = '';
					}, false);
				});

				fileLabel.addEventListener('drop', function (e) {
					const dt = e.dataTransfer;
					const files = dt.files;

					if (files.length > 0) {
						citiesFileInput.files = files;

						const event = new Event('change', { bubbles: true });
						citiesFileInput.dispatchEvent(event);
					}
				}, false);
			}

			// ================================
			// CITY DROPDOWN - SEARCH FUNCTIONALITY
			// ================================
			const cityDropdown = document.getElementById('cityDropdown');
			if (cityDropdown) {
				cityDropdown.addEventListener('keydown', function (e) {
					if (e.key === 'Enter') {
						handleCityChange();
					}
				});

				cityDropdown.addEventListener('change', function () {
					const selectedOption = this.options[this.selectedIndex];
					if (selectedOption && selectedOption.value) {
						const lat = selectedOption.getAttribute('data-lat');
						const lon = selectedOption.getAttribute('data-lon');
					}
				});
			}

			// ================================
			// METHOD DROPDOWN - LOG SELECTION
			// ================================
			const methodDropdown = document.getElementById('methodDropdown');
			if (methodDropdown) {
				methodDropdown.addEventListener('change', function () {
					const selectedOption = this.options[this.selectedIndex];
				});
			}

			// ================================
			// FORM INPUTS - CLEAR ERROR ON FOCUS
			// ================================
			const allInputs = document.querySelectorAll('input[type="text"], input[type="password"]');
			allInputs.forEach(input => {
				input.addEventListener('focus', function () {
					this.style.borderColor = '';
					this.style.backgroundColor = '';
				});
			});

			// ================================
			// PREVENT ACCIDENTAL FORM SUBMISSION
			// ================================
			document.addEventListener('keydown', function (e) {
				if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'BUTTON') {
					if (e.target.id !== 'timezoneInput') {
						const form = e.target.closest('form');
						if (!form) {
							e.preventDefault();
						}
					}
				}
			});

			// ================================
			// VISIBILITY CHANGE - PAUSE/RESUME UPDATES
			// ================================
			document.addEventListener('visibilitychange', function () {
				if (document.hidden) {
					// Do nothing
				} else {
					forceRemoveLoadingState();

					updateDeviceStatus();
					loadSavedPrayerTimes();
				}
			});

			// ================================
			// WINDOW BEFOREUNLOAD - WARN IF EDITING
			// ================================
			window.addEventListener('beforeunload', function (e) {
				if (isEditingTimezone) {
					e.preventDefault();
					e.returnValue = 'Anda sedang mengedit zona waktu. Yakin ingin meninggalkan halaman?';
					return e.returnValue;
				}

				const clearBtn = document.getElementById('clearFileBtn');
				if (clearBtn && clearBtn.style.display === 'block') {
					e.preventDefault();
					e.returnValue = 'Berkas belum diupload. Yakin ingin meninggalkan halaman?';
					return e.returnValue;
				}
			});

			// ================================
			// ONLINE/OFFLINE DETECTION
			// ================================
			window.addEventListener('online', function () {
				setTimeout(() => {
					updateDeviceStatus();
				}, 1000);
			}, 1000);

			window.addEventListener('offline', function () {
			});
		});
	</script>
</body>

</html>